{%extends "admin_staff/quantri.html" %}

{% block content_right %}
<div class="staff-page-heading" style="margin-bottom: 20px; box-shadow: 0 4px 4px rgba(0, 0, 0, 0.35);">
    <h1> Qu·∫£n l√Ω nh·∫≠p kho</h1>
    <div class="staff-page-datetime" id="current-datetime-layout-all">
    </div>
</div>

<script>
    // ‚úÖH√†m x√≥a d·∫•u ti·∫øng Vi·ªát
    function removeVietnameseTones(str) {
        return str.normalize("NFD")
                  .replace(/[\u0300-\u036f]/g, "")
                  .replace(/ƒë/g, "d").replace(/ƒê/g, "D")
                  .toLowerCase();
    }

    //‚úÖ H√†m t√≠nh kho·∫£ng c√°ch Levenshtein
    function levenshteinDistance(a, b) {
        const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
        for (let i = 0; i <= a.length; i++) dp[i][0] = i;
        for (let j = 0; j <= b.length; j++) dp[0][j] = j;

        for (let i = 1; i <= a.length; i++) {
            for (let j = 1; j <= b.length; j++) {
                if (a[i - 1] === b[j - 1]) {
                    dp[i][j] = dp[i - 1][j - 1];
                } else {
                    dp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
                }
            }
        }

        return dp[a.length][b.length];
    }

    // ‚úÖ H√†m hi·ªÉn th·ªã modal th√¥ng b√°o l·ªói
    function showErrorModalStaffImportReceipt(message) {
        const modal = document.getElementById("error-modals-staff-import-receipt");
        const messageEl = document.getElementById("error-message-staff-import-receipt");
        messageEl.textContent = message;
        modal.style.display = "flex";
    }

    function closeErrorModalStaffImportReceipt() {
        document.getElementById("error-modals-staff-import-receipt").style.display = "none";
    }

    // ‚úÖ H√†m t√¨m ki·∫øm
    function searchImportProduct() {
        const keyword = document.getElementById("searchImportProduct").value.trim().toLowerCase();
        if (!keyword) {
            showErrorModalStaffImportReceipt("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm!");
            return;
        }

        const keywordNoAccent = removeVietnameseTones(keyword);
        const rows = document.querySelectorAll("#import-product-table tbody tr");
        const isReceiptId = /^\d+$/.test(keyword);
        let found = false;

        // Reset m√†u c√°c d√≤ng
        rows.forEach(row => {
            row.querySelectorAll("td").forEach(td => {
                td.style.backgroundColor = "";
            });
        });

        if (isReceiptId) {
            rows.forEach(row => {
                if (row.dataset.receiptId === keyword) {
                    row.querySelectorAll("td").forEach(td => {
                        td.style.backgroundColor = "#ffff66";
                    });
                    found = true;
                }
            });
        } else {
            rows.forEach(row => {
                const cells = row.querySelectorAll("td");
                if (cells.length === 0) return;

                const hasRowspan = row.querySelector("td[rowspan]");
                const productCellIndex = hasRowspan ? 3 : 0;
                const productText = cells[productCellIndex].textContent.trim();
                const productName = removeVietnameseTones(productText);
                const distance = levenshteinDistance(keywordNoAccent, productName);

                if (productName.includes(keywordNoAccent) || distance <= 2) {
                    cells[productCellIndex].style.backgroundColor = "#ffff66";  // ‚úÖ Ch·ªâ t√¥ √¥ s·∫£n ph·∫©m
                    found = true;
                }
            });
        }

        if (!found) {
            showErrorModalStaffImportReceipt("Kh√¥ng t√¨m th·∫•y phi·∫øu nh·∫≠p ho·∫∑c s·∫£n ph·∫©m ph√π h·ª£p!");
        }
    }


    // ‚úÖ B·∫•m Enter ƒë·ªÉ t√¨m
    document.getElementById("searchImportProduct").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            searchImportProduct();
        }
    });
</script>


<div style="background: #fff; border-radius: 8px; padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            margin-top: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 2px solid #FFD43B; padding-bottom: 8px;">
        <!-- N√∫t m·ªü Modal -->
        <div onclick="openModalReceipt()"
             style="background-color: #E5F5E4; padding: 8px 14px; border-radius: 2px; display: inline-block; color: green; cursor: pointer;border: 1px solid green;">
            <i class="fas fa-plus"></i> NH·∫¨P KHO
        </div>
        <!-- Thanh t√¨m ki·∫øm b√™n ph·∫£i -->
        <div style="display: flex; gap: 12px; align-items: center;">
            <input id="searchImportProduct" type="text" placeholder="Nh·∫≠p ID ƒë∆°n h√†ng c·∫ßn t√¨m..."
                   style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 2px; width: 200px;">
            <button onclick="searchImportProduct()"
                    style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 2px;">
                T√¨m ki·∫øm
            </button>
        </div>
    </div>


    <!-- ‚úÖModal Phi·∫øu Nh·∫≠p -->
    <div id="modal-receipt"
         style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
        <div style="background:#fff; margin: 5% auto; width: 100%; max-width: 1200px; border-radius: 8px; overflow-y: auto; max-height: 80%;">
            <div style="background: radial-gradient(159.85% 367.97% at 150% 123.85%, #ffe147 0, #65ae17 38.76%, #469c4b 59.65%, #00713b 100%); color: white; padding: 16px; text-align: center; margin-bottom: 30px; font-size: 22px; font-weight: bold;">
                PHI·∫æU NH·∫¨P KHO
            </div>
            <div style="padding: 20px;">
                <div style="text-align:center; margin-bottom:20px;">
                    <strong>Ng√†y l·∫≠p:</strong> <span id="receipt-date">{{ receipt_date }}</span>
                </div>

                <div style="text-align:center;">
                    <strong>S·ªë phi·∫øu:</strong> <span id="receipt-number">{{ receipt_number }}</span>
                </div>

                <div style="text-align:left; margin-bottom:20px;">
                    <strong>Nh√¢n vi√™n:</strong> <span id="staff-name">{{ staff_name }}</span>
                </div>

                <!-- B·∫¢NG S·∫¢N PH·∫®M -->
                <div class="table-scroll-box"
                     style="max-height: 1000px; overflow-y: auto; border: 1px solid #ccc; border-radius: 6px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 15px;">
                        <thead style="position: sticky; top: 0; background-color: #f8f8f8;">
                        <tr style="text-align: center;">
                            <th style="padding: 10px; border: 1px solid #ccc;">STT</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">S·∫£n ph·∫©m</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Th·ªÉ lo·∫°i</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">S·ªë l∆∞·ª£ng</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Gi√° mua v√†o</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Ng√†y h·∫øt h·∫°n</th>
                            <th style="padding: 10px; border: 1px solid #ccc;"> Th√†nh ti·ªÅn</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Ghi ch√∫</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">X√≥a</th>
                        </tr>
                        </thead>
                        <tbody id="product-table-body" style="text-align: center;"></tbody>
                    </table>
                </div>

                <div class="mb-4 text-start">
                    <button type="button" id="add-product-row" class="btn btn-outline-primary"
                            style="background-color: rgba(0, 0, 0, .02); border: 1px solid green;color:green;  padding: 10px 14px; border-radius: 2px; display: inline-block; cursor: pointer;    ">
                        <i class="fas fa-plus" style="color:green;"></i> Th√™m S·∫£n Ph·∫©m
                    </button>
                </div>
                <div style="text-align: right; margin-bottom: 20px;">
                    <strong>T·ªïng ho√° ƒë∆°n:</strong> <span id="total-amount-receipt-staff">0</span> VNƒê
                </div>

                <div style="text-align:right;">
                    <button onclick="closeModalReceipt()" class="btn btn-secondary"
                            style="background-color: rgba(0, 0, 0, .02);  padding: 8px 25px; border-radius: 2px; display: inline-block; color: #333; cursor: pointer; width:150px;   border: 1px solid rgba(0, 0, 0, .09);">
                        ƒê√≥ng
                    </button>
                    <button id="save-receipt-btn"
                            style="background-color: #28a745; color: white; border: 1px solid #28a745 ; padding: 8px 25px; border-radius: 2px; cursor: pointer;width:150px;">
                        L∆∞u Phi·∫øu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!--‚úÖ Modal th√¥ng b√°o l·ªói khi nh·∫≠p phi·∫øu -->
    <div id="error-modals-staff-import-receipt"
         style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
     background: rgba(0,0,0,0.4);  justify-content: center; align-items: center;">

        <div style="background: white; border-radius: 8px; max-width: 500px; width: 100%; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

            <!-- üî¥ Header n·ªÅn ƒë·ªè ƒë·∫≠m -->
            <div style="background-color: #c0392b; padding: 12px 16px;">
                <h4 style="color: white; margin: 0; font-size: 18px; text-align:center;">Th√¥ng b√°o</h4>
            </div>

            <!-- N·ªôi dung th√¥ng b√°o -->
            <div style="padding: 20px 30px; text-align: center;">
                <p id="error-message-staff-import-receipt" style="margin-bottom: 20px; color: #333;"></p>
                <button onclick="closeErrorModalStaffImportReceipt()"
                        style="padding: 6px 20px; background: #c0392b; color: white; border: none; border-radius: 2px; cursor: pointer;">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>


    <!-- ‚úÖ Modal Th√†nh C√¥ng -->
    <div id="success-modals-staff-import-receipt"
         style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
 background: rgba(0,0,0,0.4); justify-content: center; align-items: center;">

        <div style="background: white; border-radius: 8px; max-width: 400px; width: 90%; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

            <!-- üü¢ Header n·ªÅn xanh ƒë·∫≠m -->
            <div style="background-color: #2e7d32; padding: 12px 16px;">
                <h4 style="color: white; margin: 0; font-size: 18px; text-align: center;">Th√¥ng b√°o</h4>
            </div>

            <!-- N·ªôi dung th√¥ng b√°o -->
            <div style="padding: 20px 30px; text-align: center;">
                <p style="margin: 0; font-size: 16px; color: #2e7d32; font-weight: bold;">
                    ‚úî L∆∞u phi·∫øu th√†nh c√¥ng!
                </p>
            </div>
        </div>
    </div>

    <script>
        let productList = [];
        let productRowIndex = 0;

        // ‚úÖ M·ªü modal phi·∫øu nh·∫≠p
        function openModalReceipt() {
            document.getElementById("modal-receipt").style.display = "block";
            const today = new Date();
            document.getElementById('receipt-date').innerText = today.toLocaleDateString('vi-VN');

            if (productList.length === 0) {
                fetch('/api/products')
                    .then(res => res.json())
                    .then(data => {
                    productList = data.filter(p => !p.is_deleted);
                        addProductRow();
                    });
            } else {
                addProductRow();
            }
        }

        // ‚úÖ ƒê√≥ng modal
        function closeModalReceipt() {
            document.getElementById("modal-receipt").style.display = "none";
        }

        // ‚úÖ Show modal th√†nh c√¥ng
        function showSuccessModal() {
        const modal = document.getElementById("success-modals-staff-import-receipt");
        modal.style.display = "flex";
        setTimeout(() => {
            modal.style.display = "none";
            location.reload(); // ho·∫∑c b·∫°n c√≥ th·ªÉ redirect sang trang danh s√°ch phi·∫øu nh·∫≠p
        }, 1000); // 2 gi√¢y
         }

        // ‚úÖ Th√™m d√≤ng s·∫£n ph·∫©m
        function addProductRow() {
            const tbody = document.getElementById("product-table-body");
            const tr = document.createElement("tr");

            const selectedIds = Array.from(document.querySelectorAll("select"))
                .map(s => s.value)
                .filter(Boolean);

            const productOptions = productList.map(p => {
                const disabled = selectedIds.includes(p.id.toString()) ? 'disabled' : '';
                return `<option value="${p.id}" data-category="${p.category}" ${disabled}>${p.name}</option>`;
            }).join("");

            tr.innerHTML = `
                <td>${++productRowIndex}</td>
                <td style="max-width: 250px;">
                    <select  class="form-select" onchange="updateCategory(this)" >
                        <option disabled selected>Ch·ªçn</option>
                        <span style="text-align:left;">  ${productOptions} </span>
                    </select>
                </td>
                <td class="category-cell" style="min-width:180px;"></td>
                <td style="text-align:center;">
                    <input type="number" class="form-control quantity-input" min="1" max="100" value="1" oninput="updateTotalImportReceipt(this)" />
                </td>
                <td>
                    <input type="number" class="form-control price-input" min="1000" max="1000000" step="1000" value="1000" oninput="updateTotalImportReceipt(this)" />
                </td>
                <td><input type="date" class="form-control" /></td>
                <td class="total-cell">0</td>
                <td><input type="text" class="form-control" placeholder="Ghi ch√∫..." maxlength="100" /></td>
                <td>
                    <button onclick="this.closest('tr').remove(); reindexRows()" class="btn btn-sm" style="background-color: #f7c3c2; border: none; color: #de0400; cursor: pointer; padding: 4px 8px; border-radius: 3px;">
                        <i class="fas fa-trash-alt" style="font-size:12px;"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(tr);
            updateTotalAmountStaffReceipt(); // ‚úÖ c·∫≠p nh·∫≠t t·ªïng khi th√™m

        }

        // ‚úÖ C·∫≠p nh·∫≠t lo·∫°i s·∫£n ph·∫©m
        function updateCategory(selectEl) {
            const category = selectEl.selectedOptions[0]?.dataset.category || '';
            const tr = selectEl.closest('tr');
            tr.querySelector('.category-cell').innerText = category;
        }

        // ‚úÖ C·∫≠p nh·∫≠t th√†nh ti·ªÅn
        function updateTotalImportReceipt(inputEl) {
            const tr = inputEl.closest("tr");
            const quantity = parseFloat(tr.querySelector(".quantity-input").value) || 0;
            const price = parseFloat(tr.querySelector(".price-input").value) || 0;
            const total = quantity * price;
            tr.querySelector(".total-cell").innerText = total.toLocaleString("vi-VN");
            updateTotalAmountStaffReceipt();
        }

        // ‚úÖ ƒê√°nh l·∫°i s·ªë th·ª© t·ª± sau khi xo√°
        function reindexRows() {
            const rows = document.querySelectorAll('#product-table-body tr');
            productRowIndex = 0;
            rows.forEach(tr => {
                tr.cells[0].innerText = ++productRowIndex;
            });
             updateTotalAmountStaffReceipt();
        }


        // ‚úÖ Hi·ªÉn th·ªã modal l·ªói
        function showErrorModalStaffImportReceipt(message) {
            document.getElementById("error-message-staff-import-receipt").innerText = message;
            document.getElementById("error-modals-staff-import-receipt").style.display = "flex";
        }

        // ‚úÖ ƒê√≥ng modal l·ªói
        function closeErrorModalStaffImportReceipt() {
            document.getElementById("error-modals-staff-import-receipt").style.display = "none";
        }

        // ‚úÖ B·∫Øt s·ª± ki·ªán L∆∞u phi·∫øu
document.getElementById("save-receipt-btn").addEventListener("click", async () => {
    const rows = document.querySelectorAll("#product-table-body tr");
    const products = [];
    const productMap = new Map();
    let totalQuantityAll = 0;
    let isValid = true;

    // L·∫•y d·ªØ li·ªáu t·ªìn kho v√† setting t·ª´ server
    const [inventories, settings] = await Promise.all([
        fetch("/api/product_inventories").then(res => res.json()),
        fetch("/api/settings").then(res => res.json())
    ]);

    // ƒê·ªçc c√°c gi√° tr·ªã c·∫•u h√¨nh
    const maxQuantityPerItem = parseInt(settings['max_quantity_per_item']);           // 100
    const maxInventoryAllowed = parseInt(settings['max_inventory_allowed']);           // 10
    const minQuantityPerItem = parseInt(settings['min_quantity_per_item']);            // 50
    const minTotalQuantity = parseInt(settings['min_total_quantity']);                 // 300
    const maxTotalQuantity = parseInt(settings['max_total_quantity']);                 // 1000

    rows.forEach((row, index) => {
        const select = row.querySelector("select");
        const quantityInput = row.querySelector(".quantity-input");
        const priceInput = row.querySelector(".price-input");
        const expiryInput = row.querySelector("input[type='date']");
        const noteInput = row.querySelector("input[type='text']");

        const product_id = parseInt(select.value);
        const quantity = parseFloat(quantityInput.value);
        const price = parseFloat(priceInput.value);
        const expiry_date = expiryInput.value;
        const note = noteInput.value.trim();

        if (!product_id || isNaN(product_id)) {
            showErrorModalStaffImportReceipt(`Vui l√≤ng ch·ªçn s·∫£n ph·∫©m.`);
            isValid = false;
            return;
        }

        if (isNaN(quantity) || quantity < minQuantityPerItem || quantity > maxQuantityPerItem) {
            showErrorModalStaffImportReceipt(` S·ªë l∆∞·ª£ng nh·∫≠p ph·∫£i ${minQuantityPerItem} - ${maxQuantityPerItem}.`);
            isValid = false;
            return;
        }

        if (isNaN(price) || price < 1000 || price > 1000000) {
            showErrorModalStaffImportReceipt(` Gi√° ph·∫£i t·ª´ 1.000 ƒë·∫øn 1.000.000.`);
            isValid = false;
            return;
        }

        if (!expiry_date || isNaN(new Date(expiry_date).getTime())) {
            showErrorModalStaffImportReceipt(` Ng√†y h·∫øt h·∫°n kh√¥ng h·ª£p l·ªá.`);
            isValid = false;
            return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const expiry = new Date(expiry_date);
        if (expiry <= today) {
            showErrorModalStaffImportReceipt(` Ng√†y h·∫øt h·∫°n ph·∫£i l·ªõn h∆°n h√¥m nay.`);
            isValid = false;
            return;
        }

        if (note.length < 1 || note.length > 100) {
            showErrorModalStaffImportReceipt(` Ghi ch√∫ b·∫Øt bu·ªôc, t·ªëi ƒëa 100 k√Ω t·ª±.`);
            isValid = false;
            return;
        }

        if (!productMap.has(product_id)) productMap.set(product_id, 0);
        productMap.set(product_id, productMap.get(product_id) + quantity);
        totalQuantityAll += quantity;

        products.push({
            product_id,
            quantity,
            price_import: price,
            expiry_date,
            supplier: note
        });
    });

    if (!isValid) return;

    // Ki·ªÉm tra ƒëi·ªÅu ki·ªán t·ªìn kho hi·ªán t·∫°i v√† t·ªïng sau nh·∫≠p
    for (const [product_id, addedQty] of productMap.entries()) {
        const currentQty = parseFloat(inventories[product_id] || 0);
        const newTotalQty = currentQty + addedQty;

        if (currentQty > maxInventoryAllowed) {
            showErrorModalStaffImportReceipt(`S·∫£n ph·∫©m ID ${product_id}: T·ªìn kho hi·ªán t·∫°i (${currentQty}) v∆∞·ª£t qu√° ${maxInventoryAllowed}, kh√¥ng ƒë∆∞·ª£c nh·∫≠p th√™m.`);
            isValid = false;
            break;
        }

        if (newTotalQty > maxQuantityPerItem) {
            showErrorModalStaffImportReceipt(`S·∫£n ph·∫©m ID ${product_id}: Sau khi nh·∫≠p s·∫Ω v∆∞·ª£t qu√° ${maxQuantityPerItem}.`);
            isValid = false;
            break;
        }
    }

    // Ki·ªÉm tra t·ªïng s·ªë l∆∞·ª£ng to√†n phi·∫øu
    if (totalQuantityAll < minTotalQuantity || totalQuantityAll > maxTotalQuantity) {
        showErrorModalStaffImportReceipt(`T·ªïng s·ªë l∆∞·ª£ng phi·∫øu ph·∫£i t·ª´ ${minTotalQuantity} ƒë·∫øn ${maxTotalQuantity}.`);
        isValid = false;
    }

        if (!isValid) return;

        // G·ª≠i d·ªØ li·ªáu
        fetch("/admin_staff/receipts/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ products, note: "" })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                closeModalReceipt();
                showSuccessModal();
            } else {
                showErrorModalStaffImportReceipt(data.message);
            }
        })
        .catch(() => alert("L·ªói kh√¥ng x√°c ƒë·ªãnh khi l∆∞u phi·∫øu."));
    });


        function updateTotalAmountStaffReceipt() {
            const totalCells = document.querySelectorAll('.total-cell');
            let sum = 0;

            totalCells.forEach(cell => {
                const text = cell.innerText.replace(/\./g, '').replace(',', ''); // lo·∫°i b·ªè ƒë·ªãnh d·∫°ng
                const value = parseFloat(text) || 0;
                sum += value;
            });

            document.getElementById('total-amount-receipt-staff').innerText = sum.toLocaleString('vi-VN');
        }


        // ‚úÖ N√∫t th√™m d√≤ng
        document.getElementById("add-product-row").addEventListener("click", addProductRow);
    </script>

    <!-- ‚úÖ Khung show s·∫£n ph·∫©m -->
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 15px;" id="import-product-table">
            <thead>
            <tr style="background-color: #f9f9f9;">
                <th style="padding: 10px; border: 1px solid #ccc;">M√£ phi·∫øu</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Ng√†y nh·∫≠p</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Ng∆∞·ªùi nh·∫≠p</th>
                <th style="padding: 10px; border: 1px solid #ccc;">S·∫£n ph·∫©m</th>
                <th style="padding: 10px; border: 1px solid #ccc;">S·ªë l∆∞·ª£ng</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Gi√° nh·∫≠p</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Ng√†y h·∫øt h·∫°n</th>
                <th style="padding: 10px; border: 1px solid #ccc;">T·ªïng ti·ªÅn</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Ghi ch√∫</th>
            </tr>
            </thead>
            <tbody>
            {% for receipt in receipts %}
            {% for detail in receipt.details %}
            <tr data-receipt-id="{{ receipt.id }}">
                {% if loop.index == 1 %}
                <td rowspan="{{ receipt.details|length }}"
                    style="padding: 10px; border: 1px solid #ccc; vertical-align: middle; text-align:center;">{{
                    receipt.id }}
                </td>
                <td rowspan="{{ receipt.details|length }}"
                    style="padding: 10px; border: 1px solid #ccc; vertical-align: middle;text-align:center;">{{
                    receipt.created_date.strftime('%d/%m/%Y') }}
                </td>
                <td rowspan="{{ receipt.details|length }}"
                    style="padding: 10px; border: 1px solid #ccc; vertical-align: middle;text-align:center;">{{
                    receipt.user.name if receipt.user else "N/A" }}
                </td>
                {% endif %}

                <td style="padding: 10px; border: 1px solid #ccc;">{{ detail.product.name }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;text-align:center;">{{ detail.quantity|int }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ "{:,.0f}".format(detail.price_import) }} ƒë</td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ detail.expiry_date.strftime('%d/%m/%Y') if
                    detail.expiry_date else '' }}
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ "{:,.0f}".format(detail.quantity *
                    detail.price_import) }} ƒë
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ detail.supplier or '' }}</td>
            </tr>
            {% endfor %}
            {% endfor %}
            </tbody>


        </table>

    </div>


</div>

<style>
    /* Giao di·ªán khung b·∫£ng ƒë·∫πp, cƒÉn √¥ v·ª´a ƒë·ªß */
    .table-scroll-box {
        border-radius: 6px;
        overflow-x: auto;
        border: 1px solid #ccc;
        margin-bottom: 20px;
    }

    .table-scroll-box input,
    .table-scroll-box select {
        width: 100%;
        padding: 6px 8px;
        box-sizing: border-box;
        border: none !important;
        outline: none !important;
        background: transparent;
        font-size: 14px;
        text-align:center;
    }
    /* Hover nh·∫π kh√¥ng vi·ªÅn */
    .table-scroll-box input:hover,
    .table-scroll-box select:hover {
        border: none !important;
        outline: none !important;
    }
    .table-scroll-box input:focus,
    .table-scroll-box select:focus {
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }

    /* TD c√≥ max-width, n·∫øu d√†i s·∫Ω ·∫©n ... */
    .table-scroll-box td {
        border: 1px solid #ccc;
        padding: 4px 6px;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
    }

    /* Th√™m responsive table-header n·∫øu c·∫ßn */
    .table-scroll-box th {
        border: 1px solid #ccc;
        padding: 8px;
        background-color: #f9f9f9;
        text-align: center;
        font-weight: bold;
        font-size: 14px;
    }

    .table-scroll-box td:last-child {
        text-align: center;
    }
</style>
{%endblock%}