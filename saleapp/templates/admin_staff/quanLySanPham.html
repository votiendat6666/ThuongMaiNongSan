{%extends "admin_staff/quantri.html" %}

{% block content_right %}
<div class="staff-page-heading" style="margin-bottom: 20px; box-shadow: 0 4px 4px rgba(0, 0, 0, 0.35);">
    <h1>Qu·∫£n l√Ω s·∫£n ph·∫©m</h1>
    <div class="staff-page-datetime" id="current-datetime-layout-all">
    </div>
</div>


<div style="background: #fff; border-radius: 8px; padding: 20px;box-shadow: 0 4px 16px rgba(0,0,0,0.2);margin-top: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 2px solid #FFD43B; padding-bottom: 8px;">
        <!-- Ti√™u ƒë·ªÅ b√™n tr√°i -->
        <div style="display: flex; gap: 12px;">
            <div onclick="openModalCreateProduct()"
                 style="background-color: #E5F5E4; padding: 8px 14px; border-radius: 2 px; display: inline-block; color: green; cursor: pointer; border: 1px solid green;">
                <i class="fas fa-plus"></i> TH√äM S·∫¢N PH·∫®M
            </div>

            <div onclick="openDeletedProductHistory()"
                 style="background-color: #FFE5E5; padding: 8px 14px; border-radius: 2px; display: inline-block; color: darkred; cursor: pointer; border: 1px solid darkred;">
                <i class="fas fa-history"></i> S·∫¢N PH·∫®M XO√Å
            </div>
        </div>

        <!-- Thanh t√¨m ki·∫øm b√™n ph·∫£i -->
        <div style="display: flex; gap: 12px; align-items: center;">
            <input id="searchProductInput" type="text" placeholder="Nh·∫≠p ID ho·∫∑c t√™n s·∫£n ph·∫©m..."
                   style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 300px;">
            <button onclick="searchProduct()"
                    style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px;cursor:pointer;">
                T√¨m ki·∫øm
            </button>
        </div>
        <!-- ‚úÖ JS t√¨m ki·∫øm -->
        <script>
            // ‚úÖ H√†m lo·∫°i b·ªè d·∫•u ti·∫øng Vi·ªát ƒë·ªÉ so s√°nh g·∫ßn ƒë√∫ng
            function removeVietnameseTones(str) {
                return str.normalize('NFD')
                          .replace(/[\u0300-\u036f]/g, '')
                          .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D')
                          .toLowerCase();
            }

            function searchProduct() {
                const keyword = document.getElementById("searchProductInput").value.trim().toLowerCase();
                if (!keyword) {
                    showErrorModalStaffImportReceipt("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm!");
                    return;
                }

                const keywordNoAccent = removeVietnameseTones(keyword);
                const keywordWords = keywordNoAccent.split(/\s+/); // T√°ch t·ª´ng t·ª´ trong t·ª´ kh√≥a

                const rows = document.querySelectorAll("#product-table tbody tr");
                let found = false;

                rows.forEach(row => {
                    row.style.backgroundColor = ""; // Reset m√†u
                    const cells = row.querySelectorAll("td");
                    if (cells.length === 0) return;

                    const productId = cells[0].textContent.trim().toLowerCase();
                    const productName = removeVietnameseTones(cells[1].textContent.trim());

                    // ‚úÖ So kh·ªõp t·ª´ng t·ª´ trong keyword ph·∫£i c√≥ m·∫∑t trong t√™n s·∫£n ph·∫©m
                    const matched = keywordWords.every(word => productName.includes(word));

                    if (productId.includes(keyword) || matched) {
                        row.style.transition = "background-color 0.5s";
                        row.style.backgroundColor = "#ffff66";
                        row.scrollIntoView({ behavior: "smooth", block: "center" });
                        found = true;
                    }
                });

                if (!found) {
                    showErrorModalStaffImportReceipt("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!");
                }
            }

            function showErrorModalStaffImportReceipt(message) {
                document.getElementById("error-message-staff-import-receipt").innerText = message;
                document.getElementById("error-modals-staff-view-product-detail").style.display = "flex";
            }

            function closeErrorModalStaffImportReceipt() {
                document.getElementById("error-modals-staff-view-product-detail").style.display = "none";
            }

            // ‚úÖ B·∫•m Enter ƒë·ªÉ t√¨m
            document.getElementById("searchProductInput").addEventListener("keydown", function(e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    searchProduct();
                }
            });
        </script>
    </div>


    <!-- ‚úÖ Khunh s·∫£n ph·∫©m -->
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 15px;" id="product-table">
            <thead>
            <tr style="background-color: #f9f9f9;">
                <th style="padding: 12px 10px; border: 1px solid #ccc;"> ID</th>
                <th style="padding: 12px 10px; border: 1px solid #ccc;"> T√™n s·∫£n ph·∫©m</th>
                <th style="padding: 12px 10px; border: 1px solid #ccc;"> ·∫¢nh</th>
                <th style="padding: 12px 10px; border: 1px solid #ccc;"> S·ªë l∆∞·ª£ng</th>
                <th style="padding: 12px 10px; border: 1px solid #ccc;"> T√¨nh tr·∫°ng</th>
                <th style="padding: 12px 10px; border: 1px solid #ccc;"> Gi√° b√°n</th>
                <th style="padding: 12px 10px; border: 1px solid #ccc;"> Danh m·ª•c</th>
                <th style="padding: 12px 10px; border: 1px solid #ccc;"> T√≠nh nƒÉng</th>

            </tr>
            </thead>
            <tbody>
            {% for p in products %}
            <tr style="text-align: center;">
                <td style="padding: 10px; border: 1px solid #ccc;">{{ p.id }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;text-align:left; max-width:250px;">{{ p.name }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;max-width:50px;">
                    {% if p.image %}
                    <img src="{{ p.image }}" alt="{{ p.name }}"
                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">
                    {% else %}
                    <span style="color: #999;">Kh√¥ng c√≥ ·∫£nh</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    {{ inventory_quantity_map[p.id]|int if p.id in inventory_quantity_map else 0 }}
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    {% set qty = inventory_quantity_map[p.id]|int if p.id in inventory_quantity_map else 0 %}

                    {% if qty == 0 %}
                    <span style="background-color: red; color: white; padding: 4px 8px; border-radius: 4px;">
                            ƒê√£ h·∫øt h√†ng
                        </span>
                    {% elif qty <= 10 %}
                    <span style="background-color: #f6c23e; color: black; padding: 4px 8px; border-radius: 4px;">
                            C·∫ßn nh·∫≠p h√†ng
                        </span>
                    {% else %}
                    <span style="background-color: #1cc88a; color: white; padding: 4px 8px; border-radius: 4px;">
                            C√≤n h√†ng
                        </span>
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    {{ "{:,.0f}".format(p.price) }} ƒë
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    {{ p.category.name if p.category else 'Kh√¥ng c√≥' }}
                </td>

                <td style="padding: 10px; border: 1px solid #ccc;">
                    <button class="btn btn-primary btn-sm btn-edit-product"
                            data-product-id="{{ p.id }}"
                            style="cursor:pointer; background-color: #B6FFB0; margin-right:3px; border: 1px solid #0F6D08; color: #0F6D08; padding:4px 8px; border-radius: 3px;"
                            type="button" title="Chi ti·∫øt s·∫£n ph·∫©m">
                        <i class="fa-solid fa-pen-to-square" style="font-size:12px;"></i>
                    </button>

                    <button class="btn btn-primary btn-sm btn-delete-product"
                            title="Xo√° s·∫£n ph·∫©m"
                            data-product-id="{{ p.id }}"
                            style="cursor:pointer; color: rgb(245, 157, 57); background-color:rgb(251, 226, 197); border:1px solid rgb(245, 157, 57); padding:4px 8px; border-radius: 3px;">
                        <i class="fas fa-trash-alt" style="font-size:12px;"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
            </tbody>

        </table>
    </div>

</div>



<!-- ‚úÖModal kh√¥i ph·ª•c s·∫£n ph·∫©n ƒë√£ xo√° -->
<div id="modal-deleted-product"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
    <div style="background: white; width: 1200px; margin: 40px auto; border-radius: 6px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2); max-height: 90%; overflow-y: auto; scrollbar-width: none;">
        <div style="background: radial-gradient(159.85% 367.97% at 150% 123.85%, #ffe147 0, #65ae17 38.76%, #469c4b 59.65%, #00713b 100%); color: white; padding: 16px;
                    text-align: center; margin-bottom: 30px; font-size: 22px; font-weight: bold;">
            S·∫¢N PH·∫®M ƒê√É XO√Å
        </div>

        <div style="padding: 20px;">
            <!-- Table hi·ªÉn th·ªã s·∫£n ph·∫©m ƒë√£ xo√° -->
            <table class="table-deleted-product" style="width: 100%; border-collapse: collapse;">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>H√¨nh ·∫£nh</th>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>Gi√°</th>
                    <th>Ng∆∞·ªùi xo√°</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody id="deleted-product-tbody" style="text-align: center;">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                </tbody>
            </table>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeDeletedProductHistory()"
                        style="background: radial-gradient(159.85% 367.97% at 150% 123.85%, #ffe147 0, #65ae17 38.76%, #469c4b 59.65%, #00713b 100%);
                         padding: 8px 25px; border-radius: 2px;color: white; cursor: pointer; width:150px; border: none; font-size: 15px;">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>

<!--‚úÖ JS kh√¥i ph·ª•c s·∫£n ph·∫©n ƒë√£ xo√°  -->
<script>
    let currentRestoreProductId = null;

    // M·ªü modal l·ªãch s·ª≠ s·∫£n ph·∫©m ƒë√£ xo√°
    function openDeletedProductHistory() {
        document.getElementById('modal-deleted-product').style.display = 'block';
        loadDeletedProducts();
    }

    // ƒê√≥ng modal
    function closeDeletedProductHistory() {
        document.getElementById('modal-deleted-product').style.display = 'none';
    }

    // T·∫£i danh s√°ch s·∫£n ph·∫©m ƒë√£ xo√°
    function loadDeletedProducts() {
        fetch('/api/deleted-products')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('deleted-product-tbody');
                tbody.innerHTML = '';

                data.forEach((item, index) => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td style="border: 1px solid #ccc; text-align: center;">${index + 1}</td>
                        <td style="border: 1px solid #ccc; text-align: center;">
                            <img src="${item.image}" alt="·∫¢nh" style="height: 60px; object-fit: cover; border-radius: 4px;">
                        </td>
                        <td style="border: 1px solid #ccc; width: 500px; text-align: left;">${item.name}</td>
                        <td style="border: 1px solid #ccc; text-align: center;">${item.price.toLocaleString()} ƒë</td>
                        <td style="border: 1px solid #ccc; text-align: center;">${item.deleted_by}</td>
                        <td style="border: 1px solid #ccc; text-align: center;">
                            <button onclick="openRestoreConfirmModal(${item.id})"
                                    style="padding: 6px 10px; border: none; background-color: green; color: white; border-radius: 4px; cursor: pointer;">
                                Kh√¥i ph·ª•c
                            </button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                console.error('L·ªói khi load s·∫£n ph·∫©m ƒë√£ xo√°:', err);
                alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m ƒë√£ xo√°.');
            });
    }

    // M·ªü modal x√°c nh·∫≠n kh√¥i ph·ª•c
   function openRestoreConfirmModal(productId) {
        currentRestoreProductId = productId;
        document.getElementById('modal-staff-delete-product').style.display = 'flex';
        document.getElementById('user-delete-confirm-message').textContent = 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√¥i ph·ª•c s·∫£n ph·∫©m n√†y?';

        const confirmBtn = document.getElementById('staff-confirm-delete-product');
        const newConfirmBtn = confirmBtn.cloneNode(true); // clone ƒë·ªÉ x√≥a m·ªçi listener c≈©
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        // ‚úÖ G√°n s·ª± ki·ªán m·ªõi
        newConfirmBtn.addEventListener('click', function () {
            if (!currentRestoreProductId) return;

            fetch(`/api/products/${currentRestoreProductId}/restore`, {
                method: 'POST'
            })
            .then(res => {
                if (!res.ok) throw new Error("Restore failed");
                return res.json();
            })
            .then(data => {
                // ·∫®n modal x√°c nh·∫≠n
                document.getElementById('modal-staff-delete-product').style.display = 'none';

                // Hi·ªán modal th√†nh c√¥ng
                const successModal = document.getElementById('success-modals-staff-update-product');
                successModal.style.display = 'flex';
                setTimeout(() => {
                    successModal.style.display = 'none';
                    loadDeletedProducts(); // T·∫£i l·∫°i danh s√°ch
                }, 300);
            })
            .catch(err => {
                console.error('L·ªói khi kh√¥i ph·ª•c:', err);
                alert('ƒê√£ x·∫£y ra l·ªói khi kh√¥i ph·ª•c s·∫£n ph·∫©m.');
            });
        });
    }

</script>


<!-- ‚úÖModal th√™m s·∫£n ph·∫©m -->
<div id="modal-create-product"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">

    <div style="background: white; width: 1300px; margin: 40px auto;  border-radius: 6px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2); max-height: 80%; overflow-y: auto; scrollbar-width:none">
        <div style="background: radial-gradient(159.85% 367.97% at 150% 123.85%, #ffe147 0, #65ae17 38.76%, #469c4b 59.65%, #00713b 100%); color: white; padding: 16px; text-align: center; margin-bottom: 30px; font-size: 22px; font-weight: bold;">
            TH√äM S·∫¢N PH·∫®M
        </div>
        <div style="padding: 20px;">
            <table class="table table-bordered" id="product-input-table">
                <thead>
                <tr>
                    <th style="padding: 10px; border: 1px solid #ccc;">STT</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">T√™n s·∫£n ph·∫©m</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Gi√° (VNƒê)</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">ƒê∆°n v·ªã</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Th·ªÉ lo·∫°i</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">H√¨nh ·∫£nh</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody id="product-input-tbody" style="text-align: center;">
                <!-- D√≤ng input ƒë·∫ßu ti√™n -->
                </tbody>
            </table>

            <button class="btn btn-sm btn-secondary" onclick="addProductInputRow()"
                    style="background-color: rgba(0, 0, 0, .02); border: 1px solid green;color:green;  padding: 10px 14px; border-radius: 2px; display: inline-block; cursor: pointer; margin-top:20px;    ">
                <i class="fas fa-plus" style="color:green;"></i> Th√™m S·∫£n Ph·∫©m
            </button>

            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-danger" onclick="closeModalCreateProduct()"
                        style="background-color: rgba(0, 0, 0, .02);  padding: 10px 25px; border-radius: 2px; display: inline-block; color: #333; cursor: pointer; width:150px;   border: 1px solid rgba(0, 0, 0, .09);">
                    Hu·ª∑
                </button>
                <button class="btn btn-success" onclick="submitProductForm()"
                        style="background-color: green; color: white; border: 1px solid #28a745 ; padding: 10px 25px; border-radius: 2px; cursor: pointer;width:150px;">
                    Th√™m s·∫£n ph·∫©m
                </button>

            </div>
        </div>

    </div>
</div>

<!--‚úÖJs th√™m s·∫£n ph·∫©m-->
<script>
    let productInputIndex = 0;
    let childCategories = []; // Ch·ª©a danh s√°ch th·ªÉ lo·∫°i con

    function openModalCreateProduct() {
        document.getElementById('modal-create-product').style.display = 'block';
        productInputIndex = 0;
        document.getElementById('product-input-tbody').innerHTML = '';

        // ‚úÖ G·ªçi API load danh s√°ch category
        fetch('/api/categories')
            .then(res => res.json())
            .then(categories => {
                childCategories = categories.filter(cat => cat.parent_id !== null);
                addProductInputRow(); // ‚úÖ G·ªçi sau khi load category
            });
    }

    function closeModalCreateProduct() {
        document.getElementById('modal-create-product').style.display = 'none';
    }

    function addProductInputRow() {
        const tbody = document.getElementById('product-input-tbody');
        const row = document.createElement('tr');

        // ‚úÖ T·∫°o <select> th·ªÉ lo·∫°i
        const categorySelect = document.createElement('select');
        categorySelect.name = "category_id";
        categorySelect.className = "form-control";

        childCategories.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat.id;
            option.textContent = `${cat.id} - ${cat.name}`;
            categorySelect.appendChild(option);
        });

        row.innerHTML = `
            <td style="border: 1px solid #ccc;">${productInputIndex + 1}</td>

            <td style="border: 1px solid #ccc;"><input type="text" name="name" class="form-control" /></td>
            <td style="border: 1px solid #ccc;"><input type="text" name="price" class="form-control" /></td>
            <td style="border: 1px solid #ccc;"><input type="text" name="unit" class="form-control" /></td>
            <td style="border: 1px solid #ccc;" class="category-cell"></td>
            <td style="border: 1px solid #ccc;">
                <div style="display: flex; align-items: center; gap: 6px;">
                       <input type="text" name="image_url" placeholder="Link ·∫£nh" class="form-control" style="flex: 1;" />
                        <label style="background-color: none; color: green; font-size:12px; padding: 6px 12px; border-radius: 2px; cursor: pointer;">
                            Ch·ªçn ·∫£nh
                            <input type="file" onchange="handleImageUpload(this)" accept="image/*" style="display: none;" />
                        </label>
                </div>
            </td>
            <td style="border: 1px solid #ccc; min-width:100px;">
                <button class="btn btn-danger btn-sm" onclick="removeProductRow(this)"
                    style="background-color: #f7c3c2; border: none; color: #de0400; cursor: pointer; padding: 4px 8px; border-radius: 3px;">
                    <i class="fas fa-trash-alt" style="font-size:12px;"></i>
                </button>
            </td>
        `;

        // ‚úÖ Ch√®n select v√†o c·ªôt th·ªÉ lo·∫°i
        row.querySelector(".category-cell").appendChild(categorySelect);

        tbody.appendChild(row);
        productInputIndex++;
    }

    function handleImageUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const urlInput = input.closest('tr').querySelector('input[name="image_url"]');
        const formData = new FormData();
        formData.append('image', file);

        // üëâ Hi·ªán spinner
        document.getElementById("modals-comment-loading").style.display = "flex";

        fetch('/api/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.url) {
                urlInput.value = data.url;
            } else {
                alert("L·ªói upload ·∫£nh: " + data.error);
            }
        })
        .catch(err => {
            console.error("Upload error:", err);
            alert("L·ªói k·∫øt n·ªëi t·ªõi server");
        })
        .finally(() => {
            // üëâ Lu√¥n ·∫©n spinner sau khi xong
            document.getElementById("modals-comment-loading").style.display = "none";
        });
    }

    function removeProductRow(button) {
        const row = button.closest('tr');
        row.remove();

        // C·∫≠p nh·∫≠t l·∫°i STT
        const rows = document.querySelectorAll('#product-input-tbody tr');
        rows.forEach((row, index) => {
            const sttCell = row.querySelector('td');
            if (sttCell) sttCell.textContent = index + 1;
        });

        productInputIndex = rows.length;
    }
    function showError(message) {
        document.getElementById("error-message-staff-import-receipt").textContent = message;
        document.getElementById("error-modals-staff-view-product-detail").style.display = "flex";
    }

    function closeErrorModalStaffImportReceipt() {
        document.getElementById("error-modals-staff-view-product-detail").style.display = "none";
    }

    function submitProductForm() {
        const rows = document.querySelectorAll('#product-input-tbody tr');
        const products = [];

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const name = row.querySelector('input[name="name"]').value.trim();
            const price = row.querySelector('input[name="price"]').value.trim();
            const unit = row.querySelector('input[name="unit"]').value.trim();
            const category_id = row.querySelector('select[name="category_id"]').value;
            const image_url = row.querySelector('input[name="image_url"]').value.trim();

            if (!name || !price || !unit || !category_id || !image_url) {
                showError(`Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng b·∫•t k·ª≥ tr∆∞·ªùng n√†o.`);
                return;
            }

            if (name.length > 100) {
                showError(`T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 100 k√Ω t·ª±.`);
                return;
            }

            const priceNumber = parseFloat(price);
            if (isNaN(priceNumber) || priceNumber < 0 || priceNumber > 10000000) {
                showError(`Gi√° ph·∫£i l√† s·ªë t·ª´ 0 ƒë·∫øn 10,000,000.`);
                return;
            }

            if (unit.length > 10) {
                showError(`ƒê∆°n v·ªã kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 10 k√Ω t·ª±.`);
                return;
            }

            products.push({
                name,
                price: priceNumber,
                unit,
                category_id,
                image_url
            });
        }

        // ‚úÖ G·ª≠i d·ªØ li·ªáu
        fetch('/api/products/bulk-create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(products)
        })
        .then(res => res.json())
        .then(response => {
            if (response.message) {
                const successModal = document.getElementById("success-modals-staff-update-product");
                successModal.style.display = "flex";
                setTimeout(() => {
                    successModal.style.display = "none";
                    closeModalCreateProduct();
                    location.reload();
                }, 300);
            }
            else {
                showError("C√≥ l·ªói x·∫£y ra khi l∆∞u s·∫£n ph·∫©m.");
            }
        })
        .catch(err => {
            showError("L·ªói k·∫øt n·ªëi ƒë·∫øn server.");
            console.error(err);
        });
    }

</script>


<!-- ‚úÖModal s·ª≠a S·∫£n ph·∫©m -->
<div id="modal-edit-product"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;background-color: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">

    <div style="background:white; border-radius:2px; width:1000px; max-height:90%; overflow:auto;scrollbar-width:none;">
        <!-- Header -->
        <div style="background-color: #28a745; padding: 16px;">
            <h3 style="margin: 0; text-align: center; color: white;">CHI TI·∫æT S·∫¢N PH·∫®M </h3>
        </div>

        <div style="padding:20px;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 24px; font-size: 14px; padding:20px; margin-bottom: 30px;">
                <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="padding: 10px; border: 1px solid #dee2e6;">M√£ ƒê∆°n</th>
                    <th style="padding: 10px; border: 1px solid #dee2e6;">·∫¢nh</th>
                    <th style="padding: 10px; border: 1px solid #dee2e6;">T√™n s·∫£n ph·∫©m</th>
                    <th style="padding: 10px; border: 1px solid #dee2e6;">S·ªë l∆∞·ª£ng</th>
                    <th style="padding: 10px; border: 1px solid #dee2e6;">Lo·∫°i h√†ng</th>
                </tr>
                </thead>
                <tbody id="inventory-detail-table" style="text-align: center;">
                <!-- JS s·∫Ω render d·ªØ li·ªáu v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>


        <!-- Form -->
        <form id="edit-product-form"
              style="padding: 20px; display: flex; flex-direction: column; gap: 16px;font-family: 'Roboto', sans-serif;">
            <input type="hidden" id="product-id">

            <!-- H√†ng 1: T√™n, Gi√° -->
            <div class="form-row">
                <div class="form-group">
                    <label>T√™n s·∫£n ph·∫©m:</label>
                    <input type="text" id="product-name" class="form-control">
                </div>
                <div class="form-group">
                    <label>Gi√°:</label>
                    <input type="number" id="product-price" class="form-control">
                </div>
            </div>

            <!-- H√†ng 2: Danh m·ª•c, Voucher -->
            <div class="form-row">
                <div class="form-group">
                    <label>Danh m·ª•c:</label>
                    <select id="product-category" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label>Voucher:</label>
                    <input type="number" id="product-voucher" class="form-control">
                </div>
            </div>

            <!-- H√†ng 3: ƒê√£ b√°n, L∆∞·ª£t th√≠ch -->
            <div class="form-row">
                <div class="form-group">
                    <label>ƒê√£ b√°n:</label>
                    <input type="number" id="product-daban" class="form-control">
                </div>
                <div class="form-group">
                    <label>L∆∞·ª£t th√≠ch:</label>
                    <input type="number" id="product-like" class="form-control">
                </div>
            </div>

            <!-- H√†ng 4: ƒê∆°n v·ªã t√≠nh, H√¨nh ·∫£nh -->
            <div class="form-row">
                <div class="form-group">
                    <label>ƒê∆°n v·ªã t√≠nh:</label>
                    <input type="text" id="product-donvitinh" class="form-control">
                </div>
                <div class="form-group">
                    <label>H√¨nh ·∫£nh:</label>
                    <input type="text" id="product-image" class="form-control">
                </div>
            </div>

            <!-- C√°c d√≤ng 1 c·ªôt -->
            <div class="form-group full-width">
                <label>Th∆∞∆°ng hi·ªáu:</label>
                <input type="text" id="product-thuong_hieu" class="form-control">
            </div>

            <div class="form-group full-width">
                <label>Xu·∫•t x·ª©:</label>
                <input type="text" id="product-xuat_xu" class="form-control">
            </div>

            <div class="form-group full-width">
                <label>Quy c√°ch ƒë√≥ng g√≥i:</label>
                <input type="text" id="product-quy_cach_dong_goi" class="form-control">
            </div>

            <div class="form-group full-width">
                <label>B·∫£o qu·∫£n:</label>
                <textarea id="product-bao_quan" class="form-control"></textarea>
            </div>

            <div class="form-group full-width">
                <label>C√°ch d√πng:</label>
                <textarea id="product-cach_dung" class="form-control"></textarea>
            </div>

            <div class="form-group full-width">
                <label>M√¥ t·∫£ s·∫£n ph·∫©m chi ti·∫øt:</label>
                <textarea id="product-mo_ta_san_pham" class="form-control"></textarea>
            </div>

            <!-- Footer -->
            <div style="margin-top: 16px; text-align: right;">
                <button type="button" onclick="closeEditProductModal()" class="btn btn-secondary"
                        style=" padding: 7px 16px; width:180px; background-color: white; color: #111; border: 1px solid #555; border-radius: 2px; cursor: pointer;">
                    ƒê√≥ng
                </button>
                <button type="submit" class="btn btn-success"
                        style=" padding: 7px 16px; width:180px; background-color: #28a745; color: white; border: 1px solid #28a745; border-radius: 2px; cursor: pointer;">
                    L∆∞u
                </button>
            </div>
        </form>
    </div>
</div>

<!--‚úÖ JS s·ª≠a s·∫£n ph·∫©m-->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".btn-edit-product").forEach(button => {
            button.addEventListener("click", () => {
                const productId = button.getAttribute("data-product-id");
                fetch(`/api/productsEdit/${productId}`)
                    .then(res => res.json())
                    .then(product => {
                        document.getElementById("product-id").value = product.id;
                        document.getElementById("product-name").value = product.name || "";
                        document.getElementById("product-price").value = product.price || 0;
                        document.getElementById("product-image").value = product.image || "";
                        document.getElementById("product-voucher").value = product.voucher || 0;
                        document.getElementById("product-daban").value = product.daban || 0;
                        document.getElementById("product-like").value = product.like || 0;
                        document.getElementById("product-donvitinh").value = product.donvitinh || "";
                        document.getElementById("product-thuong_hieu").value = product.thuong_hieu || "";
                        document.getElementById("product-xuat_xu").value = product.xuat_xu || "";
                        document.getElementById("product-quy_cach_dong_goi").value = product.quy_cach_dong_goi || "";
                        document.getElementById("product-bao_quan").value = product.bao_quan || "";
                        document.getElementById("product-cach_dung").value = product.cach_dung || "";
                        document.getElementById("product-mo_ta_san_pham").value = product.mo_ta_san_pham || "";

                        // ‚úÖ Load danh s√°ch danh m·ª•c t·ª´ API
                        fetch('/api/categories')
                            .then(res => res.json())
                            .then(categories => {
                                const select = document.getElementById("product-category");
                                select.innerHTML = "";

                                // ‚ùå B·ªè qua c√°c th·ªÉ lo·∫°i cha (parent_id === null)
                                const childCategories = categories.filter(cat => cat.parent_id !== null);

                                childCategories.forEach(cat => {
                                    const option = document.createElement("option");
                                    option.value = cat.id;
                                    option.textContent = `${cat.id} - ${cat.name}`;
                                    select.appendChild(option);
                                });

                                // ‚úÖ G√°n gi√° tr·ªã ƒë√£ ch·ªçn n·∫øu c√≥
                                select.value = product.category_id || "";
                            });

                        // ‚úÖ Hi·ªÉn th·ªã modal v√† load t·ªìn kho
                        document.getElementById("modal-edit-product").style.display = "flex";
                        fetchProductInventory(productId);
                    });
            });
        });
    });


    function fetchProductInventory(productId) {
        fetch(`/api/product-inventory/${productId}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("inventory-detail-table");
                tbody.innerHTML = "";

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 12px;">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho.</td></tr>`;
                    return;
                }

                data.forEach(p => {
                    const typeColor = p.type === 1 ? 'green' : 'orange';
                    const typeLabel = p.type === 1 ? 'H√†ng m·ªõi' : 'H√†ng c≈©';

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td style="padding: 8px; border: 1px solid #ccc;">${p.id}</td>
                        <td style="padding: 8px; border: 1px solid #ccc;">
                            <img src="${p.image}" alt="·∫¢nh" style="width: 60px; height: auto;">
                        </td>
                        <td style="padding: 8px; border: 1px solid #ccc;">${p.name}</td>
                        <td style="padding: 8px; border: 1px solid #ccc;">${p.quantity}</td>
                        <td style="padding: 8px; border: 1px solid #ccc; color: ${typeColor}; font-weight: bold;">
                            ${typeLabel}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(err => {
                console.error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ªìn kho:", err);
                const tbody = document.getElementById("inventory-detail-table");
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 12px;">L·ªói khi t·∫£i d·ªØ li·ªáu t·ªìn kho.</td></tr>`;
            });
    }

    function closeEditProductModal() {
        document.getElementById("modal-edit-product").style.display = "none";
    }

    document.getElementById("edit-product-form").addEventListener("submit", function (e) {
        e.preventDefault();

        const requiredFields = [
            "product-name",
            "product-price",
            "product-image",
            "product-category",
            "product-donvitinh",
            "product-thuong_hieu",
            "product-xuat_xu",
            "product-quy_cach_dong_goi",
            "product-bao_quan",
            "product-cach_dung",
            "product-mo_ta_san_pham"
        ];

        for (let fieldId of requiredFields) {
            const input = document.getElementById(fieldId);
            if (!input.value || input.value.trim() === "") {
                modalsViewProductDetail("Tr∆∞·ªùng \"" + input.previousElementSibling?.innerText + "\" kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
                return;
            }
        }

        const id = document.getElementById("product-id").value;
        const data = {
            name: document.getElementById("product-name").value,
            price: parseFloat(document.getElementById("product-price").value),
            image: document.getElementById("product-image").value,
            category_id: parseInt(document.getElementById("product-category").value),
            voucher: parseFloat(document.getElementById("product-voucher").value || 0),
            daban: parseFloat(document.getElementById("product-daban").value || 0),
            like: parseInt(document.getElementById("product-like").value || 0),
            donvitinh: document.getElementById("product-donvitinh").value,
            thuong_hieu: document.getElementById("product-thuong_hieu").value,
            xuat_xu: document.getElementById("product-xuat_xu").value,
            quy_cach_dong_goi: document.getElementById("product-quy_cach_dong_goi").value,
            bao_quan: document.getElementById("product-bao_quan").value,
            cach_dung: document.getElementById("product-cach_dung").value,
            mo_ta_san_pham: document.getElementById("product-mo_ta_san_pham").value
        };

        fetch(`/api/productsEdit/${id}`, {
            method: "PUT",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(response => {
                modalsViewUpdateProductSuccess();
                closeEditProductModal();
                location.reload();
            })
            .catch(err => modalsViewProductDetail("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + err));
    });

    function modalsViewProductDetail(message) {
        const modal = document.getElementById("error-modals-staff-view-product-detail");
        const messageBox = document.getElementById("error-message-staff-import-receipt");

        messageBox.textContent = message || "ƒê√£ x·∫£y ra l·ªói!";
        modal.style.display = "flex";  // hi·ªÉn th·ªã d·∫°ng flex ƒë·ªÉ align center
    }

    function closeErrorModalStaffImportReceipt() {
        const modal = document.getElementById("error-modals-staff-view-product-detail");
        modal.style.display = "none";
    }

    function modalsViewUpdateProductSuccess() {
        const modal = document.getElementById("success-modals-staff-update-product");
        modal.style.display = "flex";

        setTimeout(() => {
            modal.style.display = "none";
        }, 300); // 0.3 gi√¢y
    }
</script>



<!--üî¥  Modal th√¥ng b√°o l·ªói khi s·ª≠a s·∫£n ph·∫©m -->
<div id="error-modals-staff-view-product-detail"
     style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
         background: rgba(0,0,0,0.4);  justify-content: center; align-items: center;">

    <div style="background: white; border-radius: 8px; max-width: 500px; width: 100%; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

        <!-- Header n·ªÅn ƒë·ªè ƒë·∫≠m -->
        <div style="background-color: #c0392b; padding: 12px 16px;">
            <h4 style="color: white; margin: 0; font-size: 18px; text-align:center;">Th√¥ng b√°o</h4>
        </div>

        <!-- N·ªôi dung th√¥ng b√°o -->
        <div style="padding: 20px 30px; text-align: center;">
            <p id="error-message-staff-import-receipt" style="margin-bottom: 20px; color: #333;"></p>
            <button onclick="closeErrorModalStaffImportReceipt()"
                    style="padding: 6px 20px; background: #c0392b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ƒê√≥ng
            </button>
        </div>
    </div>
</div>

<!-- ‚úÖ Modal Th√†nh C√¥ng -->
<div id="success-modals-staff-update-product"
     style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
 background: rgba(0,0,0,0.4); justify-content: center; align-items: center;">

    <div style="background: white; border-radius: 8px; max-width: 400px; width: 90%; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

        <!-- üü¢ Header n·ªÅn xanh ƒë·∫≠m -->
        <div style="background-color: #2e7d32; padding: 12px 16px;">
            <h4 style="color: white; margin: 0; font-size: 18px; text-align: center;">Th√¥ng b√°o</h4>
        </div>

        <!-- N·ªôi dung th√¥ng b√°o -->
        <div style="padding: 20px 30px; text-align: center;">
            <p style="margin: 0; font-size: 16px; color: #2e7d32; font-weight: bold;">
                ‚úî C·∫≠p nh·∫≠t th√†nh c√¥ng!
            </p>
        </div>
    </div>
</div>

<!-- ‚úÖ Modal x√°c nh·∫≠n xo√° s·∫£n ph·∫©m -->
<div id="modal-staff-delete-product"
     style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
     background: rgba(0,0,0,0.4); justify-content: center; align-items: center;">

    <div style="background: white; border-radius: 8px; max-width: 400px; width: 90%; overflow: hidden;
         box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

        <!-- üü¢ Header -->
        <div style="background-color: #2e7d32; padding: 12px 16px;">
            <h4 style="color: white; margin: 0; font-size: 18px; text-align: center;">Th√¥ng b√°o</h4>
        </div>

        <!-- N·ªôi dung -->
        <div style="padding: 20px 30px; text-align: center;">
            <p id="user-delete-confirm-message" style="margin: 0; font-size: 16px; color: #2e7d32; font-weight: bold;">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° s·∫£n ph·∫©m n√†y?
            </p>

            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 20px;">
                <button id="staff-not-confirm-delete-product" class="btn btn-secondary"
                        style="background-color: #f0f0f0; color: #333; padding: 6px 12px; width: 120px; border: 1px solid #ddd; border-radius: 2px; cursor: pointer;">
                    Hu·ª∑
                </button>

                <button id="staff-confirm-delete-product" class="btn btn-danger"
                        style="background-color: #2e7d32; color: white; padding: 6px 12px; width: 120px; border: none; border-radius: 2px; cursor: pointer;">
                    X√°c nh·∫≠n
                </button>
            </div>
        </div>
    </div>
</div>

<!--/ ‚úÖ JS xo√° s·∫£n ph·∫©m-->
<script>
    let selectedProductId = null;
    let originalSuccessMessage = "";

    // Khi ·∫•n v√†o n√∫t xo√°
    document.querySelectorAll('.btn-delete-product').forEach(btn => {
        btn.addEventListener('click', function () {
            selectedProductId = this.getAttribute('data-product-id');
            document.getElementById('modal-staff-delete-product').style.display = 'flex';
        });
    });

    // ·∫§n Hu·ª∑
    document.getElementById('staff-not-confirm-delete-product').addEventListener('click', function () {
        document.getElementById('modal-staff-delete-product').style.display = 'none';
        selectedProductId = null;
    });

    // ·∫§n X√°c nh·∫≠n
    document.getElementById('staff-confirm-delete-product').addEventListener('click', async function () {
        if (!selectedProductId) return;

        try {
            const res = await fetch(`/delete_product/${selectedProductId}`, {
                method: 'POST'
            });

            if (res.ok) {
                // ·∫®n modal x√°c nh·∫≠n
                document.getElementById('modal-staff-delete-product').style.display = 'none';

                // ‚úÖ Ghi nh·ªõ th√¥ng b√°o g·ªëc
                const successModal = document.getElementById('success-modals-staff-update-product');
                const msgElem = successModal.querySelector("p");

                originalSuccessMessage = msgElem.innerText;
                msgElem.innerText = "‚úî Xo√° th√†nh c√¥ng!";

                // Hi·ªán modal th√†nh c√¥ng
                successModal.style.display = 'flex';

                // Sau 0.3s th√¨ ·∫©n v√† reset l·∫°i n·ªôi dung c≈©
                setTimeout(() => {
                    successModal.style.display = 'none';
                    msgElem.innerText = originalSuccessMessage;

                    // ‚úÖ Reload trang (n·∫øu c·∫ßn thi·∫øt)
                    location.reload();
                }, 300);
            } else {
                alert("L·ªói khi xo√° s·∫£n ph·∫©m!");
            }
        } catch (err) {
            console.error("L·ªói:", err);
            alert("L·ªói server!");
        }
    });
</script>
<!--‚úÖ Spinner overlay -->
<div id="modals-comment-loading"
     style="display: none;position: fixed; z-index: 9999; top: 0; left: 0;width: 100%; height: 100%;background: rgba(255,255,255,0.7);align-items: center; justify-content: center;">
    <div class="spinner"></div>
</div>


<!--‚úÖ Style -->
<style>
    #product-input-table {
        width: 100%;
        border-collapse: collapse;
    }

    #product-input-table th,
    #product-input-table td {
        border-bottom: 1px solid #ccc;
        vertical-align: middle;
    }

    #product-input-table th {
        background-color: #f5f5f5;
    }

    /* Xo√° vi·ªÅn input nh∆∞ b·∫°n mu·ªën */
    #product-input-table input {
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
        background: transparent;
    }

    #product-input-table input:focus {
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
    }
    #product-input-tbody select {
        border: none;
        box-shadow: none;
        outline: none;
        background-color: transparent;
    }
        .form-row {
        display: flex;
        gap: 16px;
        justify-content: space-between;
    }

    .form-group {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .full-width {
        width: 100%;
        display: flex;
        flex-direction: column;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
    }

    label {
        font-weight: bold;
        margin-bottom: 4px;
    }
    textarea.form-control {
        resize: none;
        height: 120px;
        overflow-y: auto;
                font-family: 'Roboto', sans-serif;

    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
        .table-deleted-product {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #ccc; /* Vi·ªÅn ngo√†i b·∫£ng */
    }

    .table-deleted-product th,
    .table-deleted-product td {
        padding: 12px;
        border: 1px solid #ccc; /* Vi·ªÅn gi·ªØa c√°c √¥: d·ªçc v√† ngang */
        text-align: center;
    }

    .table-deleted-product thead th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
</style>

{%endblock%}