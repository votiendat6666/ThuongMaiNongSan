{%extends "admin_staff/quantri.html" %}

{% block content_right %}
<!-- Heading -->
<style>
    #modal-import-user input,
    #modal-import-user select {
        border: none !important;
        outline: none !important;
        background-color: transparent;
    }

    #modal-import-user input:focus,
    #modal-import-user select:focus {
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }
</style>


<div class="staff-page-heading" style="margin-bottom: 20px; box-shadow: 0 4px 4px rgba(0, 0, 0, 0.35);">
    <h1>Qu·∫£n l√Ω kh√°ch h√†ng</h1>
    <div class="staff-page-datetime" id="current-datetime-layout-all">
    </div>
</div>


<div style="background: #fff; border-radius: 8px; padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            margin-top: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 2px solid #FFD43B; padding-bottom: 8px;">
        <!-- nut them khach hang -->
        <div onclick="openModalImportUser()"
             style="background-color: #E5F5E4; padding: 8px 14px; border-radius: 2px; display: inline-block; color: green; cursor: pointer;border: 1px solid green;">
            <i class="fas fa-plus"></i> TH√äM KH√ÅCH H√ÄNG
        </div>
        <!-- Thanh t√¨m ki·∫øm b√™n ph·∫£i -->
        <div style="display: flex; gap: 12px; align-items: center;">
            <input id="searchCustomerInput" type="text" placeholder="Nh·∫≠p ID, t√™n ho·∫∑c username..."
                   style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 300px;">
            <button onclick="searchCustomer()"
                    style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                T√¨m ki·∫øm
            </button>
        </div>
    </div>


    <div id="modal-import-user"
         style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 8px; width: 1400px; max-height: 90%; overflow-y: auto;">
            <div style="background: radial-gradient(159.85% 367.97% at 150% 123.85%, #ffe147 0, #65ae17 38.76%, #469c4b 59.65%, #00713b 100%);
            color: white; padding: 16px; text-align: center; margin-bottom: 30px; font-size: 30px; font-weight: bold;">
                TH√äM KH√ÅCH H√ÄNG
            </div>
            <div style="padding: 20px;">
                <form id="form-add-user">
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ccc;">
                        <thead>
                        <tr style="background-color: #f0f0f0;">
                            <th style="padding: 10px; border: 1px solid #ccc;">STT</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">T√™n</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">T√†i kho·∫£n</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">M·∫≠t kh·∫©u</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Email</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Gi·ªõi t√≠nh</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">SƒêT</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Ng√†y sinh</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">H√†nh ƒë·ªông</th>
                        </tr>
                        </thead>
                        <tbody id="user-table-body">
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ccc;">1</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <input type="text" name="name[]" required style="width: 100%;">
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <input type="text" name="username[]" required style="width: 100%;">
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <input type="password" name="password[]" required style="width: 100%;">
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <input type="email" name="email[]" required style="width: 100%;">
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <select name="gender[]" style="width: 100%;">
                                    <option value="">--</option>
                                    <option value="MALE">Nam</option>
                                    <option value="FEMALE">N·ªØ</option>
                                    <option value="OTHER">Kh√°c</option>
                                </select>
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <input type="text" name="phone[]" style="width: 100%;">
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <input type="date" name="birthday[]" style="width: 100%;">
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">
                                <button type="button" onclick="this.closest('tr').remove(); reindexRows()"
                                        style="background-color: #f7c3c2; border: none; color: #de0400; cursor: pointer; padding: 4px 8px; border-radius: 3px;">
                                    <i class="fas fa-trash-alt" style="font-size:12px;"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <div style="margin-top: 16px; display: flex; justify-content: space-between;">
                        <button type="button" onclick="addRowUser()"
                                style="background-color: rgba(0, 0, 0, .02); border: 1px solid green;color:green;  padding: 10px 14px; border-radius: 2px; display: inline-block; cursor: pointer; ">
                            + Th√™m d√≤ng
                        </button>
                        <div>
                            <button type="button" onclick="closeModalImportUser()"
                                    style="background-color: rgba(0, 0, 0, .02);  padding: 8px 25px; border-radius: 2px; display: inline-block; color: #333; cursor: pointer; width:150px;   border: 1px solid rgba(0, 0, 0, .09);">
                                H·ªßy
                            </button>

                            <button type="submit"
                                    style="background-color: #28a745; color: white; border: 1px solid #28a745 ; padding: 8px 25px; border-radius: 2px; cursor: pointer;width:150px;">
                                L∆∞u
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ‚úÖ JS theme khach hang -->
    <script>
        function openModalImportUser() {
            document.getElementById("modal-import-user").style.display = "flex";
        }

        function closeModalImportUser() {
            document.getElementById("modal-import-user").style.display = "none";
        }

        function addRowUser() {
            const tbody = document.getElementById("user-table-body");
            const rowCount = tbody.rows.length + 1;

            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td style="padding: 10px; border: 1px solid #ccc;">${rowCount}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <input type="text" name="name[]" required style="width: 100%; border: none; outline: none;">
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <input type="text" name="username[]" required style="width: 100%; border: none; outline: none;">
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <input type="password" name="password[]" required style="width: 100%; border: none; outline: none;">
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <input type="email" name="email[]" required style="width: 100%; border: none; outline: none;">
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <select name="gender[]" style="width: 100%; border: none; outline: none;">
                        <option value="">--</option>
                        <option value="MALE">Nam</option>
                        <option value="FEMALE">N·ªØ</option>
                        <option value="OTHER">Kh√°c</option>
                    </select>
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <input type="text" name="phone[]" style="width: 100%; border: none; outline: none;">
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <input type="date" name="birthday[]" style="width: 100%; border: none; outline: none;">
                </td>
                <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">
                    <button type="button" onclick="this.closest('tr').remove(); reindexRows()"
                            style="background-color: #f7c3c2; border: none; color: #de0400; cursor: pointer; padding: 4px 8px; border-radius: 3px;">
                        <i class="fas fa-trash-alt" style="font-size:12px;"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
        }

        function reindexRows() {
            const rows = document.querySelectorAll("#user-table-body tr");
            rows.forEach((row, index) => {
                row.querySelector("td").textContent = index + 1;
            });
        }

    function isValidRow(row, index) {
        const username = row.querySelector('input[name="username[]"]').value.trim();
        const name = row.querySelector('input[name="name[]"]').value.trim();
        const password = row.querySelector('input[name="password[]"]').value.trim();
        const email = row.querySelector('input[name="email[]"]').value.trim();
        const gender = row.querySelector('select[name="gender[]"]').value.trim();
        const phone = row.querySelector('input[name="phone[]"]').value.trim();
        const birthday = row.querySelector('input[name="birthday[]"]').value;

        if (!username || !name || !password || !email || !gender || !phone || !birthday) {
            throw ` Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng b·∫•t k·ª≥ tr∆∞·ªùng n√†o.`;
        }

        // ‚úÖ Ki·ªÉm tra t√™n: Cho ph√©p d·∫•u, kho·∫£ng tr·∫Øng, t·ª´ 2 ƒë·∫øn 40 k√Ω t·ª±
        if (name.length < 2 || name.length > 40) {
            throw ` T√™n ph·∫£i t·ª´ 2 ƒë·∫øn 40 k√Ω t·ª±.`;
        }

        // ‚úÖ Ki·ªÉm tra username: kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng, kh√¥ng k√Ω t·ª± ƒë·∫∑c bi·ªát
        if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
            throw ` T√†i kho·∫£n ch·ªâ g·ªìm ch·ªØ, s·ªë, d·∫•u _ (kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng), t·ª´ 3-20 k√Ω t·ª±.`;
        }

        if (!/^[a-zA-Z0-9_]{3,20}$/.test(password)) {
            throw ` M·∫≠t kh·∫©u ch·ªâ g·ªìm ch·ªØ, s·ªë, d·∫•u _ (kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng), t·ª´ 3-20 k√Ω t·ª±.`;
        }

        if (!email.includes("@")) {
            throw ` Email kh√¥ng h·ª£p l·ªá (thi·∫øu @).`;
        }

        if (!/^0\d{9}$/.test(phone)) {
            throw ` S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng s·ªë 0.`;
        }

        const birthDate = new Date(birthday);
            const now = new Date();
            const age = now.getFullYear() - birthDate.getFullYear();
            if (age < 5 || birthDate > now) {
                throw ` Ng√†y sinh kh√¥ng h·ª£p l·ªá ho·∫∑c tu·ªïi d∆∞·ªõi 5.`;
            }

            return true;
        }


       document.getElementById("form-add-user").addEventListener("submit", function (e) {
        e.preventDefault();

        const rows = document.querySelectorAll("#user-table-body tr");
        let allValid = true;
        let errorMessage = "";

        for (let i = 0; i < rows.length; i++) {
            try {
                isValidRow(rows[i], i);
            } catch (err) {
                allValid = false;
                errorMessage = err;
                break;
            }
        }

        if (!allValid) {
            document.getElementById("error-modals-import-user").style.display = "flex";
            document.getElementById("error-message-staff-import-receipt").textContent = "‚ùå " + errorMessage;
            return;
        }

        // Submit n·∫øu h·ª£p l·ªá
        const formData = new FormData(this);
        fetch("/api/add-users", {
            method: "POST",
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    if (data.errors && data.errors.length > 0) {
                        const msg = data.errors.join("\n");
                        document.getElementById("error-modals-import-user").style.display = "flex";
                        document.getElementById("error-message-staff-import-receipt").textContent = msg;
                        return; // d·ª´ng kh√¥ng x·ª≠ l√Ω ti·∫øp
                    }

                    // ‚úÖ Kh√¥ng l·ªói: x·ª≠ l√Ω th√†nh c√¥ng
                    document.getElementById("success-modals-import-user").style.display = "flex";
                    setTimeout(() => {
                        document.getElementById("success-modals-import-user").style.display = "none";
                        closeModalImportUser();
                        document.getElementById("form-add-user").reset();
                        document.querySelector("#user-table-body").innerHTML = "";
                        addRowUser(); // reset v·ªÅ 1 d√≤ng
                         location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.message || "C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!");
                }
            })
            .catch(err => {
                // Hi·ªÉn th·ªã l·ªói trong modal
                document.getElementById("error-modals-import-user").style.display = "flex";
                document.getElementById("error-message-staff-import-receipt").textContent = "‚ùå " + (err.message || err);
            });

        });


        function closeErrorModalStaffImportReceipt() {
            document.getElementById("error-modals-import-user").style.display = "none";
        }
    </script>


    <div id="error-modals-import-user"
         style="display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%;background: rgba(0,0,0,0.4);  justify-content: center; align-items: center;">

        <div style="background: white; border-radius: 8px; max-width: 500px; width: 100%; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

            <!-- üî¥ Header n·ªÅn ƒë·ªè ƒë·∫≠m -->
            <div style="background-color: #c0392b; padding: 12px 16px;">
                <h4 style="color: white; margin: 0; font-size: 18px; text-align:center;">Th√¥ng b√°o</h4>
            </div>

            <!-- N·ªôi dung th√¥ng b√°o -->
            <div style="padding: 20px 30px; text-align: center;">
                <p id="error-message-staff-import-receipt" style="margin-bottom: 20px; color: #333;"></p>
                <button onclick="closeErrorModalStaffImportReceipt()"
                        style="padding: 6px 20px; background: #c0392b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <div id="success-modals-import-user"
         style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;background: rgba(0,0,0,0.4); justify-content: center; align-items: center;">

        <div style="background: white; border-radius: 8px; max-width: 400px; width: 90%; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

            <!-- üü¢ Header n·ªÅn xanh ƒë·∫≠m -->
            <div style="background-color: #2e7d32; padding: 12px 16px;">
                <h4 style="color: white; margin: 0; font-size: 18px; text-align: center;">Th√¥ng b√°o</h4>
            </div>

            <!-- N·ªôi dung th√¥ng b√°o -->
            <div style="padding: 20px 30px; text-align: center;">
                <p style="margin: 0; font-size: 16px; color: #2e7d32; font-weight: bold;">
                    ‚úî L∆∞u kh√°ch h√†ng th√†nh c√¥ng!
                </p>
            </div>
        </div>
    </div>


    <!-- ‚úÖ JS t√¨m ki·∫øm -->
    <script>
        // ‚úÖ H√†m lo·∫°i b·ªè d·∫•u ti·∫øng Vi·ªát
        function removeVietnameseTones(str) {
            return str.normalize('NFD')
                      .replace(/[\u0300-\u036f]/g, '')
                      .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D')
                      .toLowerCase();
        }

        // ‚úÖ T√¨m ki·∫øm kh√°ch h√†ng theo ID, t√™n, username
        function searchCustomer() {
            const keyword = document.getElementById("searchCustomerInput").value.trim().toLowerCase();
            if (!keyword) {
                showErrorModalCustomer("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm!");
                return;
            }

            const keywordNoAccent = removeVietnameseTones(keyword);
            const keywordWords = keywordNoAccent.split(/\s+/);

            const rows = document.querySelectorAll("#customer-table tbody tr");
            let found = false;

            rows.forEach(row => {
                row.style.backgroundColor = ""; // Reset
                const cells = row.querySelectorAll("td");
                if (cells.length === 0) return;

                const customerId = cells[0].textContent.trim().toLowerCase();
                const customerName = removeVietnameseTones(cells[1].textContent.trim());
                const customerUsername = removeVietnameseTones(cells[2].textContent.trim());

                // Kh·ªõp t·ª´ng t·ª´ trong keyword
                const matchedName = keywordWords.every(word => customerName.includes(word));
                const matchedUsername = keywordWords.every(word => customerUsername.includes(word));

                if (customerId.includes(keyword) || matchedName || matchedUsername) {
                    row.style.transition = "background-color 0.5s";
                    row.style.backgroundColor = "#ffff66";
                    row.scrollIntoView({ behavior: "smooth", block: "center" });
                    found = true;
                }
            });

            if (!found) {
                showErrorModalCustomer("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng!");
            }
        }

        function showErrorModalCustomer(message) {
            document.getElementById("error-message-customer").innerText = message;
            document.getElementById("error-modal-customer").style.display = "flex";
        }

        function closeErrorModalCustomer() {
            document.getElementById("error-modal-customer").style.display = "none";
        }

        // ‚úÖ B·∫•m Enter ƒë·ªÉ t√¨m
        document.getElementById("searchCustomerInput").addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                searchCustomer();
            }
        });
    </script>

    <!-- ‚úÖ Modal th√¥ng b√°o t√¨m ki·∫øm kh√¥ng c√≥ -->
    <div id="error-modal-customer"
         style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
         background: rgba(0,0,0,0.4); justify-content: center; align-items: center;">

        <div style="background: white; border-radius: 8px; max-width: 500px; width: 100%; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
            <div style="background-color: #c0392b; padding: 12px 16px;">
                <h4 style="color: white; margin: 0; font-size: 18px; text-align:center;">Th√¥ng b√°o</h4>
            </div>
            <div style="padding: 20px 30px; text-align: center;">
                <p id="error-message-customer" style="margin-bottom: 20px; color: #333;"></p>
                <button onclick="closeErrorModalCustomer()"
                        style="padding: 6px 20px; background: #c0392b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>


    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;" id="customer-table">
            <thead style="background: #f2f2f2;">
            <tr>
                <th style="padding: 10px; border: 1px solid #ccc;">#</th>
                <th style="padding: 10px; border: 1px solid #ccc;">T√†i kho·∫£n</th>
                <th style="padding: 10px; border: 1px solid #ccc;">H·ªç t√™n</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Email</th>
                <th style="padding: 10px; border: 1px solid #ccc;">SƒêT</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Gi·ªõi t√≠nh</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Ng√†y sinh</th>
                <th style="padding: 10px; border: 1px solid #ccc;">S·ªë ƒë∆°n</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Xu</th>
                <th style="padding: 10px; border: 1px solid #ccc;">H·∫°ng</th>
                <th style="padding: 10px; border: 1px solid #ccc;">H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody>
            {% for user in users %}
            <tr style="text-align: center;">
                <td style="padding: 10px; border: 1px solid #ccc;">{{ loop.index }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ user.username }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ user.name }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ user.email }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ user.phone or '' }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    {{ 'Nam' if user.gender and user.gender.name == 'MALE' else 'N·ªØ' if user.gender and user.gender.name
                    == 'FEMALE' else '' }}
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    {{ user.birthday.strftime('%d/%m/%Y') if user.birthday else '' }}
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ user.receipts | length }}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">{{ user.coin }}</td>

                <td style="padding: 10px; border: 1px solid #ccc;">
                    {% if user.total_spent >= 10000000 %}
                    <span style="font-size: 13px; color: #fff; padding: 4px 12px; background: linear-gradient(135deg, #434343, #000000); border-radius: 8px; display: inline-block;">
                        Kim c∆∞∆°ng
                    </span>
                    {% elif user.total_spent >= 5000000 %}
                    <span style="font-size: 13px; color: #fff; padding: 4px 12px; background: #E6B800; border-radius: 8px; display: inline-block;">
                        V√†ng
                    </span>
                    {% else %}
                    <span style="font-size: 13px; color: #fff; padding: 4px 12px; background: #BBC1C7; border-radius: 8px; display: inline-block;">
                        B·∫°c
                    </span>
                    {% endif %}
                </td>

                <td style="padding: 10px; border: 1px solid #ccc;">
                    <button class="btn btn-primary btn-sm btn-delete-user"
                            data-user-id="{{ user.id }}"
                            style="cursor:pointer; background-color: #f7c3c2; margin-right:3px; border: 1px solid #de0400; color: #de0400; padding:4px 8px; border-radius: 3px;"
                            type="button" title="X√≥a ng∆∞·ªùi d√πng">
                        <i class="fas fa-trash-alt" style="font-size:12px;"></i>
                    </button>

                    <button class="btn btn-primary btn-sm btn-view-user"
                            data-user-id="{{ user.id }}"
                            title="Xem chi ti·∫øt kh√°ch h√†ng"
                            style="cursor:pointer; color: rgb(245, 157, 57); background-color:rgb(251, 226, 197); border:1px solid rgb(245, 157, 57); padding:4px 8px; border-radius: 3px;">
                        <i class="fa-solid fa-eye" style="font-size:12px; color:rgb(245, 157, 57);"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

    </div>

</div>


<!-- ‚úÖ Modal Xem l·ªäCH S·ª≠ Kh√°ch H√†ng -->
<div id="modal-view-user"
     style="display: none; position: fixed; z-index: 3000; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 8px; max-width: 1200px; width: 90%;
                max-height: 90vh; overflow-y: auto; scrollbar-width:none;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

        <!-- ‚úÖ Header -->
        <div style="background-color: #28a745; padding: 16px;">
            <h3 style="margin: 0; text-align: center; color: white;">L·ªäCH S·ª¨ C·ª¶A KH√ÅCH H√ÄNG </h3>
        </div>

        <!-- ‚úÖ N·ªôi dung b·∫£ng -->
        <div style="padding: 20px;">
            <h2 style="text-align:center;"> ƒê∆†N MUA</h2>
            <table style="width: 100%; border-collapse: collapse; text-align: center;">
                <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 10px; border: 1px solid #ccc;">M√£ ƒê∆°n</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Ng∆∞·ªùi nh·∫≠n</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Li√™n h·ªá</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">S·ª≠ d·ª•ng xu</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Voucher</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Ng√†y mua</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">H√¨nh th·ª©c</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">T·ªïng ti·ªÅn</th>
                </tr>
                </thead>
                <tbody id="user-purchase-table-receipt">
                <!-- JavaScript s·∫Ω render d·ªØ li·ªáu ·ªü ƒë√¢y -->
                </tbody>
            </table>
        </div>

        <div style="padding: 20px;">
            <h2 style="text-align:center;"> B√åNH LU·∫¨N </h2>
            <table style="width: 100%; border-collapse: collapse; text-align: center;">
                <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 10px; border: 1px solid #ccc;"> ·∫¢nh</th>
                    <th style="padding: 10px; border: 1px solid #ccc;"> T√™n s·∫£n ph·∫©m</th>
                    <th style="padding: 10px; border: 1px solid #ccc;"> N·ªôi dung</th>
                    <th style="padding: 10px; border: 1px solid #ccc;"> ·∫¢nh</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">S·ªë sao</th>
                    <th style="padding: 10px; border: 1px solid #ccc;"> Ng√†y</th>
                </tr>
                </thead>
                <tbody id="user-purchase-table-comment">
                <!-- JavaScript s·∫Ω render d·ªØ li·ªáu ·ªü ƒë√¢y -->
                </tbody>
            </table>
        </div>

        <div style="padding: 20px;">
            <h2 style="text-align:center;"> S·∫¢N PH·∫®M Y√äU TH√çCH </h2>
            <table style="width: 100%; border-collapse: collapse; text-align: center;">
                <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 10px; border: 1px solid #ccc;"> ID S·∫£n ph·∫©m</th>
                    <th style="padding: 10px; border: 1px solid #ccc;"> ·∫¢nh</th>
                    <th style="padding: 10px; border: 1px solid #ccc;"> T√™n s·∫£n ph·∫©m</th>
                </tr>
                </thead>
                <tbody id="user-purchase-table-loveProduct">
                <!-- JavaScript s·∫Ω render d·ªØ li·ªáu ·ªü ƒë√¢y -->
                </tbody>
            </table>
        </div>

        <!-- ‚úÖ N√∫t ƒë√≥ng -->
        <div style="text-align: right; padding: 10px 20px;">
            <button onclick="closeModalUserPurchase()"
                    style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ƒê√≥ng
            </button>
        </div>
    </div>
</div>


<!-- ‚úÖ JS Xem ƒê∆°n H√†ng Kh√°ch H√†ng -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".btn-view-user").forEach(button => {
            button.addEventListener("click", () => {
                const userId = button.getAttribute("data-user-id");
                fetchUserPurchases(userId);
                fetchUserComments(userId);
                fetchUserLoveProducts(userId);

            });
        });
    });

    function fetchUserPurchases(userId) {
        fetch(`/api/users/${userId}/purchases`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const tbody = document.getElementById("user-purchase-table-receipt");
                tbody.innerHTML = "";

                data.forEach(receipt => {
                    const row = `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ccc;">${receipt.receipt_id}</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">${receipt.receiver_name}</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">${receipt.receiver_phone}</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">${receipt.coin_used || 0}</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">${receipt.voucher_discount > 0 ? receipt.voucher_discount + "‚Ç´" : "Kh√¥ng"}</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">${receipt.created_date}</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">${receipt.delivery_method}</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">${receipt.final_amount.toLocaleString()}ƒë</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById("modal-view-user").style.display = "flex";
            })
            .catch(error => {
                console.error("‚ùå L·ªói khi g·ªçi API:", error);
            });
    }

    function fetchUserComments(userId) {
        fetch(`/api/users/${userId}/comments`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const tbody = document.getElementById("user-purchase-table-comment");
                tbody.innerHTML = "";

                data.forEach(comment => {
                    const row = `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <img src="${comment.product_image}" width="60">
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc;max-width:100px;text-align:left;">${comment.product_name}</td>
                            <td style="padding: 10px; border: 1px solid #ccc; max-width:150px; word-wrap:break-word; white-space:pre-wrap; text-align:left;">${comment.content}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc; max-width:150px; ">
                                 ${comment.images.map(img => `<img src="${img}" width="70" height="70" style="object-fit: cover; margin-right: 4px;">`).join("")}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc; color:#FF8C00">${comment.star} ‚òÖ</td>
                            <td style="padding: 10px; border: 1px solid #ccc;max-width:60px;">${comment.created_date}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error("‚ùå L·ªói khi g·ªçi API comments:", error);
            });
    }

    function fetchUserLoveProducts(userId) {
        fetch(`/api/users/${userId}/love-products`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const tbody = document.getElementById("user-purchase-table-loveProduct");
                tbody.innerHTML = "";

                data.forEach(product => {
                    const row = `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ccc;">${product.product_id}</td>
                            <td style="padding: 10px; border: 1px solid #ccc;">
                                <img src="${product.product_image}" width="60" height="60" style="object-fit: cover;">
                            </td>
                            <td style="padding: 10px; border: 1px solid #ccc;">${product.product_name}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error("‚ùå L·ªói khi g·ªçi API commented-products:", error);
        });
    }

    function closeModalUserPurchase() {
        document.getElementById("modal-view-user").style.display = "none";
    }
</script>

<!--‚úÖ Xo√° ng∆∞·ªùi d√πng-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let userIdToDelete = null;

        document.querySelectorAll(".btn-delete-user").forEach(button => {
            button.addEventListener("click", function () {
                userIdToDelete = this.getAttribute("data-user-id");
                document.getElementById("user-delete-confirm-modal").style.display = "flex";
            });
        });

        document.getElementById("user-delete-cancel-btn").addEventListener("click", function () {
            document.getElementById("user-delete-confirm-modal").style.display = "none";
            userIdToDelete = null;
        });

        document.getElementById("user-delete-confirm-btn").addEventListener("click", function () {
            if (!userIdToDelete) return;

            fetch(`/api/users/${userIdToDelete}`, {
                method: "DELETE"
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    document.getElementById("user-delete-confirm-modal").style.display = "none";
                    const successModal = document.getElementById("success-modals-staff-delete-user");
                    successModal.style.display = "flex";
                    setTimeout(() => {
                        successModal.style.display = "none";
                        location.reload();
                    }, 300);
                } else {
                    console.error(data.error || "X√≥a kh√¥ng th√†nh c√¥ng!");
                }
            })
            .catch(error => {
                console.error("L·ªói khi g·ªçi API: " + error);
            });
        });
    });

</script>


<!-- ‚úÖ Modal x√°c nh·∫≠n xo√° ng∆∞·ªùi d√πng -->
<div id="user-delete-confirm-modal"
     style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;background: rgba(0,0,0,0.4); justify-content: center; align-items: center;">

    <div style="background: white; border-radius: 8px; max-width: 400px; width: 90%; overflow: hidden;
         box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

        <!-- üü¢ Header -->
        <div style="background-color: #2e7d32; padding: 12px 16px;">
            <h4 style="color: white; margin: 0; font-size: 18px; text-align: center;">Th√¥ng b√°o</h4>
        </div>

        <!-- N·ªôi dung -->
        <div style="padding: 20px 30px; text-align: center;">
            <p id="user-delete-confirm-message" style="margin: 0; font-size: 16px; color: #2e7d32; font-weight: bold;">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° ng∆∞·ªùi d√πng n√†y?
            </p>

            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 20px;">
                <button id="user-delete-cancel-btn" class="btn btn-secondary"
                        style="background-color: #f0f0f0; color: #333; padding: 6px 12px; width: 120px; border: 1px solid #ddd; border-radius: 2px; cursor: pointer;">
                    Hu·ª∑
                </button>

                <button id="user-delete-confirm-btn" class="btn btn-danger"
                        style="background-color: #2e7d32; color: white; padding: 6px 12px; width: 120px; border: none; border-radius: 2px; cursor: pointer;">
                    X√°c nh·∫≠n
                </button>
            </div>
        </div>
    </div>
</div>


<!-- ‚úÖ Modal x√°c nh·∫≠n xo√° ng∆∞·ªùi d√πng th√†nh c√¥ng -->
<div id="success-modals-staff-delete-user"
     style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
 background: rgba(0,0,0,0.4); justify-content: center; align-items: center;">

    <div style="background: white; border-radius: 8px; max-width: 400px; width: 90%; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">

        <!-- üü¢ Header n·ªÅn xanh ƒë·∫≠m -->
        <div style="background-color: #2e7d32; padding: 12px 16px;">
            <h4 style="color: white; margin: 0; font-size: 18px; text-align: center;">Th√¥ng b√°o</h4>
        </div>

        <!-- N·ªôi dung th√¥ng b√°o -->
        <div style="padding: 20px 30px; text-align: center;">
            <p style="margin: 0; font-size: 16px; color: #2e7d32; font-weight: bold;">
                ‚úî Xo√° th√†nh c√¥ng!
            </p>
        </div>
    </div>
</div>

{%endblock%}