{% extends 'layout/base.html' %}

{% import 'user/voucher_macro.html' as voucher_macros %}

{%block title%} Thanh toán {%endblock%}


{%block navbar%}
<div style="width:100%; background: linear-gradient(  to bottom,  #00713b,  #469c4b); height:40px;"></div>
<div class="container-fluid"
     style="padding:0; background-color:white; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">

    <!-- Thanh tiêu đề -->
    <div style="height:100px; display:flex; align-items:center;">
        <div class="container" style="display:flex; align-items:center; padding:0 20px;">
            <a class="navbar-brand" href="/" style="font-size:30px; color:#ee4d2d; display:flex; align-items:center;">
                <img src="{{ url_for('static', filename='images/logo2.png') }}"
                     style="height:45px; width:auto; margin-right:15px;" alt="DoubleTD Logo">
            </a>
            <div style="width:2px; height:40px; background-color:#00713b; margin-right:15px;"></div>
            <div style="font-size:30px; color:#00713b; font-weight:600; line-height:35px; position: relative; padding-top:19px;">
                Thanh Toán
            </div>
        </div>
    </div>
</div>

{% endblock %}

{%block content%}


<!--✅ Style Địa chỉ -->
<style>
    /* ✅ Modal overlay */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9999; display: none; align-items: center; justify-content: center; }

    /* ✅ Modal overlay active */
    .modal-overlay.active { display: flex; }

    /* ✅ Hộp modal */
    .modal-box {  background: #fff;  width: 500px;  max-width: 600px;  height: 600px; /* Hoặc height: auto; min-height: 600px; */ border-radius: 8px;  overflow: hidden;  display: flex;  flex-direction: column;}

    /* ✅ Header modal */
    .modal-header { padding: 16px; font-weight: 500; font-size: 25px; border-bottom: 1px solid #ddd; color: rgba(0,0,0,.8); }

    /* ✅ Body modal */
    .modal-body { padding: 16px; padding-bottom:0; display: flex; flex-direction: column; gap: 12px; }

    /* ✅ Footer modal */
    .modal-footer { padding: 12px 16px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #ddd; }

    /* ✅ Radio container */
    .custom-radio { position: relative; cursor: pointer; user-select: none; }

    /* ✅ Ẩn radio gốc */
    .custom-radio input[type="radio"] { position: absolute; opacity: 0; }

    /* ✅ Hình radio custom */
    .custom-radio .radio-check { position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 18px; width: 18px; border: 2px solid rgba(0,0,0,0.26); border-radius: 50%; box-sizing: border-box; }

    /* ✅ Khi checked */
    .custom-radio input[type="radio"]:checked + .radio-check { border-color: #00713b; }

    /* ✅ Chấm bên trong */
    .custom-radio .radio-check::after { content: ""; position: absolute; display: none; }
    .custom-radio input[type="radio"]:checked + .radio-check::after { display: block; }
    .custom-radio .radio-check::after { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; border-radius: 50%; background: #00713b; }

    /* ✅ Hover không đổi border */
    .custom-radio:hover .radio-check { border-color: rgba(0,0,0,0.26); }

    /* ✅ Danh sách địa chỉ */
    .address-list {  flex: 1;  overflow-y: auto;  scrollbar-width: none;}

    /* ✅ Mỗi item địa chỉ */
    .address-item { display: block; padding: 12px 16px; border-bottom: 1px solid #eee; cursor: pointer; }

    /* ✅ Bỏ border item cuối */
    .address-list .address-item:last-of-type { border-bottom: none; }

    /* ✅ Nội dung item */
    .address-content { display: flex; flex-direction: column; gap: 6px; }

    /* ✅ Phần trên item */
    .address-top { display: flex; justify-content: space-between; align-items: center; }

    /* ✅ Info trong item */
    .address-info { display: flex; align-items: center; gap: 10px; position: relative; padding-left: 28px; }

    /* ✅ Dòng địa chỉ */
    .address-line, .address-region { padding-left: 40px; color: #333; }

    /* ✅ Vùng thêm mới */
    .address-add { padding: 12px 16px; text-align: left; }

    /* ✅ Nhóm input */
    .input-group { display: flex; gap: 10px; }
    .input-group input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

    /* ✅ Dropdown address */
    .dropdown-address { position: relative; }
    .dropdown-address button { width: 100%; padding: 10px; text-align: left; border: 1px solid #ddd;  background: #fff; }
    .dropdown-box { display: none; position: absolute; top: 100%; left: 0; width: 100%; border: 1px solid #ddd; background: #fff; z-index: 1000; }

    /* ✅ Tab header */
    .tab-header { display: flex; border-bottom: 1px solid #eee; }

    /* ✅ Tab */
    .tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; }

    /* ✅ Tab active */
    .tab.active { border-bottom: 2px solid red; color: red; }

    /* ✅ Danh sách tab */
    .tab-list { max-height: 290px; overflow-y: auto; }
    .tab-list div { padding: 8px; cursor: pointer; }
    .tab-list div:hover { color: #00713b; }
    .tab.disabled { cursor: not-allowed; opacity: 0.5; }

    /* ✅ Textarea */
    textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

    /* ✅ Button chính */
    .btn-primary { background: #00713b; color: #fff; border: none; width: 180px; height: 41px; border-radius: 4px; cursor: pointer; border: 1px solid #00713b; }

    .btn-primary:focus, .btn-primary:active { background: #00713b !important; border-color: #00713b !important; color: #fff !important; outline: none !important;  box-shadow: none !important;}

    /* ✅ Button viền */
    .btn-outline { background: transparent; border: 1px solid #00713b; color: #00713b; width: 150px; height: 41px; border-radius: 4px; cursor: pointer; }

    /* ✅ Hover button */
    .btn-primary:hover { background-color:  #005f2c; color: #fff; border-color: #005f2c; }

    .btn-outline:hover { background-color: #00713b; color: #fff; }

    /* ✅ Tắt navbar */
    nav.navbar { display: none !important; }

    /* ✅ Tắt banner */
    .imgTieuDe { display: none; }


</style>

<!-- ✅Thanh màu đè lên viền khung -->
<div style="position: relative; height: 3px; background-image: repeating-linear-gradient(45deg, #6fa6d6, #6fa6d6 33px, transparent 0,
            transparent 41px, #f18d9b 0, #f18d9b 74px, transparent 0, transparent 82px);
            background-position-x: -30px; background-size: 116px 3px; width: 100%; z-index: 2;"></div>

<!-- ✅Khung trắng full, tiêu đề + nội dung -->
<div style="position: relative; background: white;  border-top: none; padding: 20px; margin-top: -1px; width: 100%; box-sizing: border-box;">

    <!-- Tiêu đề -->
    <h3 style="margin: 0 0 15px 0; font-size: 22px; color: #ee4d2d;">
        <i class="fa-solid fa-location-dot" style="margin-right:10px;"></i>
        Địa Chỉ Nhận Hàng
    </h3>

    <!-- Dòng thông tin -->
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: nowrap;">

        <!-- Cụm bên trái: Tên + SĐT + Địa chỉ + Mặc định -->
        <div style="display: flex; min-width: 0; flex: 1; align-items: center; overflow: hidden;">

            <!-- Phần text chính -->
            <span id="addressText" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
               {% for address in addresses %}
                  {% if address.is_default %}
                    <strong id="userName" style="margin-right:10px;">{{ address.receiver_name }}</strong>
                    <span id="userPhone">
                      <strong>(+84) <span id="phoneNumber"
                                          style="margin-right:10px;">{{ address.receiver_phone }}</span></strong>
                    </span>
                    <span id="userAddress">
                      {{ address.receiver_address_line }},
                      {{ address.receiver_ward }},
                      {{ address.receiver_district }},
                      {{ address.receiver_province }}
                    </span>
                  {% endif %}
                {% endfor %}
            </span>

            <!-- Mặc định -->
            <span id="defaultLabel"
                  style="flex-shrink: 0; margin-left: 10px; font-size: 12px; color: #ee4d2d; font-weight: 600; border: 1px solid #ee4d2d; padding: 2px 6px; border-radius: 2px;">
                Mặc định
            </span>
        </div>

        <!-- Nút Thay đổi -->
        <button onclick="openAddressModal()"
                style="flex-shrink: 0; padding: 6px 16px; font-size: 14px; background: none; color: #05a !important; border: none; border-radius: 4px; cursor: pointer;">
            Thay đổi
        </button>

    </div>
</div>

<!--✅ Modal 1: Chọn Địa Chỉ -->
<div id="addressModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"> Địa Chỉ Của Tôi</div>
        <div class="address-list">
            {% for address in addresses %}
            <label class="address-item custom-radio">
                <div class="address-content">
                    <div class="address-top">
                        <div class="address-info">
                            <input type="radio" name="addressOption"
                                   value="{{ address.id }}"
                                   data-name="{{ address.receiver_name }}"
                                   data-phone="{{ address.receiver_phone }}"
                                   data-province="{{ address.receiver_province }}"
                                   data-district="{{ address.receiver_district }}"
                                   data-ward="{{ address.receiver_ward }}"
                                   data-line="{{ address.receiver_address_line }}"
                                   {% if address.is_default or loop.first %} checked {% endif %}>
                            <span class="radio-check"></span>
                            <strong style="font-size:20px;">{{ address.receiver_name }}</strong>
                            <span style="height:30px; border-right: 1px solid #ccc;"></span>
                            <span>(+84) {{ address.receiver_phone }}</span>
                        </div>
                        <button type="button"
                                style="background: transparent; border: none; color: #08f; padding: 8px 16px; border-radius: 4px; cursor: pointer;"
                                onclick="openEditAddressModal(true, '{{ address.id }}')">
                            Thay đổi
                        </button>
                    </div>
                    <div class="address-line">{{ address.receiver_address_line }}</div>
                    <div class="address-region">{{ address.receiver_ward }}, {{ address.receiver_district }}, {{
                        address.receiver_province }}
                    </div>
                </div>
            </label>
            {% endfor %}

            <div class="address-add">
                <button type="button" onclick="openEditAddressModal(false)"
                        style="display: inline-flex; align-items: center; justify-content: center; gap: 1px; background:#fff ; color: #00713b; border: none;
                  height: 41px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0, 0, 0, .09); ">
                    <span class="material-symbols-outlined"
                          style="font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;">add</span>
                    Thêm địa chỉ mới
                </button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-outline" onclick="closeAddressModal()">Huỷ</button>
            <button class="btn-primary" onclick="setDefaultAddress()">Xác nhận</button>
        </div>
    </div>
</div>
<!-- ✅Modal 2: Sửa/Thêm Địa Chỉ -->
<div id="editAddressModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header" id="editAddressModalTitle">Sửa Địa Chỉ</div>
        <div class="modal-body">
            <div class="input-group">
                <input type="text" id="editName" placeholder="Họ tên" maxlength="25" required>
                <input type="text" id="editPhone" placeholder="Số điện thoại" maxlength="10" required>
                <p id="errorMsg" style="color: red; font-size: 13px;"></p>

                <script>
                    // Hàm Kiểm tra name và SDT lưu địa chỉ
                    function validateInputs() {
                        const nameInput = document.getElementById("editName");
                        const phoneInput = document.getElementById("editPhone");

                        const name = nameInput.value.trim();
                        const phone = phoneInput.value.trim();

                        let isValid = true;

                        // Reset viền trước mỗi lần kiểm tra
                        nameInput.style.border = "";
                        phoneInput.style.border = "";

                        // Kiểm tra họ tên
                        if (name.length < 3 || name.length > 25) {
                            nameInput.style.border = "1px solid red";
                            isValid = false;
                        }

                        // Kiểm tra số điện thoại
                        const phoneRegex = /^0\d{9}$/;
                        if (!phoneRegex.test(phone)) {
                            phoneInput.style.border = "1px solid red";
                            isValid = false;
                        }

                        return isValid;
                    }
                </script>
            </div>
            <div class="dropdown-address" id="provinceDropdown">
                <button type="button" id="addressResult" onclick="toggleAddressTabs()">Chọn Tỉnh/Thành phố, Quận/Huyện,
                    Phường/Xã ⌵
                </button>
                <div id="addressTabs" class="dropdown-box">
                    <div class="tab-header">
                        <div id="tab-province" onclick="switchTab('province')" class="tab active">Tỉnh/Thành phố</div>
                        <div id="tab-district" onclick="switchTab('district')" class="tab">Quận/Huyện</div>
                        <div id="tab-ward" onclick="switchTab('ward')" class="tab">Phường/Xã</div>
                    </div>
                    <div id="tabList" class="tab-list"></div>
                </div>
            </div>
            <textarea style="height:246px;" id="editSpecificAddress"
                      placeholder="Nhập địa chỉ cụ thể"
                      maxlength="100"></textarea>
            <p id="charCountMsg" style="font-size: 12px; color: gray;">0/100 ký tự</p>

            <script>
                const textarea = document.getElementById("editSpecificAddress");
                const charCountMsg = document.getElementById("charCountMsg");

                textarea.addEventListener("input", function () {
                    charCountMsg.textContent = `${this.value.length}/100 ký tự`;
                });
            </script>
        </div>

        <button type="button" onclick="deleteAddress()"
                style="display: inline-flex; align-items: center; justify-content: center; gap: 1px; background:#fff ; color: red; border: none;
                  height: 41px; border-radius: 4px; cursor: pointer;  margin: 5px 12px;">
            <span style="width:15px; border-bottom:2px solid red; border-radius:60px; margin-right:4px;">  </span> Xoá
            địa chỉ
        </button>

        <div class="modal-footer">
            <button class="btn-outline" onclick="closeEditAddressModal()">Huỷ</button>
            <button class="btn-primary" onclick="saveAddress()">Lưu</button>
        </div>
    </div>
</div>


<!-- Khung sản phẩm -->
<div class="cart-wrapper" style="height: auto; display: flex; flex-direction: column; margin: 20px 0px;">
    <style>
        table.table tr {
          border-bottom: 1px solid #ddd;
        }
        table.table tr:last-child {
          border-bottom: 1px solid transparent;
        }
    </style>
    <!-- Danh sách SP -->
    <div style="flex: 1; overflow-y: auto; background-color: white; scrollbar-width: none; padding: 0px 30px;">
        {% if selected_cart_items %}
        <table class="table" style="margin-top:10px; font-size:14px; width: 100%;">
            <tr style="color:;">
                <th style="width: 50%; text-align: left; font-size: 22px; vertical-align: middle; font-weight:400">Sản
                    Phẩm
                </th>
                <th style="width: 15%; text-align: center; vertical-align: middle; font-weight:400">Đơn giá</th>
                <th style="width: 15%; text-align: center; vertical-align: middle;font-weight:400">Số lượng</th>
                <th style="width: 20%; text-align: center; vertical-align: middle;font-weight:400">Thành tiền</th>
            </tr>

            {% for c in selected_cart_items %}
            <tr id="product{{ c.product.id }}" style="vertical-align: middle;">
                <td style="width: 50%;">
                    <a href="/products/{{ c.product.id }}" style="text-decoration: none; color: inherit;">
                        <img src="{{ c.product.image }}" alt="{{ c.product.name }}"
                             style="width:70px; height:70px; margin-right:10px;">
                        {{ c.product.name }}
                    </a>
                </td>
                <td style="width: 15%; text-align:center;">
                    <span style="vertical-align: 3px; font-size:12px;">₫</span>{{ c.product.price|format_vnd }}
                </td>
                <td style="width: 15%; text-align: center;">
                    {{ c.quantity }} {{c.product.donvitinh }}
                </td>
                <td style="width: 20%; color:#ee4d2d; text-align:center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <span style="vertical-align: 3px; font-size:12px;">₫</span>{{ '{:,.0f}'.format(c.quantity *
                    c.product.price).replace(',', '.') }}
                </td>
            </tr>
            {% endfor %}
        </table>
        {% endif %}
    </div>


</div>

<!--Khung nhap tin nhan cho nguoi ban-->
<div style="width: 100%; background: #f9fcfd; border: 1px solid #eee; padding: 20px; box-sizing: border-box; margin-bottom: 20px;">
    <!-- Dòng Lời nhắn & Voucher -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
        <!-- Lời nhắn -->
        <div style="flex: 1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Lời nhắn:</label>
            <textarea
                    id="note_message"
                    name="note_message"
                    placeholder="Lưu ý cho Người bán..."
                    maxlength="100"
                    oninput="updateCharCount()"
                    style="width: 100%; height: 150px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-family: inherit; font-size: 14px; line-height: 1.5;"></textarea>
        </div>

    </div>
    <div id="charCount" style="margin-top: 4px; font-size: 13px; color: #555;">
        0 / 100 ký tự
    </div>
    <script>
        function updateCharCount() {
            const textarea = document.getElementById('note_message');
            const countDiv = document.getElementById('charCount');
            const currentLength = textarea.value.length;
            countDiv.textContent = `${currentLength} / 100 ký tự`;
        }
    </script>


    <!-- Phương thức vận chuyển -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-top: 1px dashed #ddd; padding-top: 15px;">
        <div>
            <strong>Phương thức vận chuyển:</strong> Nhanh
            <div style="font-size: 13px; color: #555; margin-top: 5px;">
                Đảm bảo nhận hàng trước {{ delivery_date }}<br>
                Nhận Voucher trị giá ₫15.000 nếu đơn hàng được giao đến bạn sau {{ delivery_date }}.<br>
                Lưu ý: Sử dụng địa chỉ mua hàng trước sáp nhập
            </div>
        </div>
        <div style="text-align: right;">
            <!--            <button style="color: #0071bc; border: none; background:none; margin-right: 10px;">Thay Đổi</button>-->
            <strong style="display: inline-block;">₫0</strong>
        </div>
    </div>

    <!-- Không đồng kiểm -->
    <div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; display: flex; align-items: center;">
        <label style="font-size: 14px; color: #555;">Không đồng kiểm.</label>
    </div>

    <!-- Tổng số tiền -->

    <div style="text-align: right; padding: 10px 0;">
      <span style="font-size: 16px; color: #555; margin-right: 10px;">
        Tổng số tiền ({{ order_total_product_selected }} sản phẩm)
      </span>
        <span style="color: #ee4d2d; font-size: 30px;">
            <span style="vertical-align: 7px; font-size:20px;">₫</span>{{ '{:,.0f}'.format(order_total_amount_selected).replace(',','.') }}
        </span>
    </div>


</div>

<!-- VOUCHER + XU -->
<div style="background: #fff; border: 1px solid #f0f0f0; border-radius: 4px; padding: 40px 20px; margin-bottom:20px;">
    <!-- VOUCHER -->
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center;">
            <img src="https://i.postimg.cc/BQmxtQRR/coupon.png" alt="Voucher Icon"
                 style="width: 25px; height: 25px; margin-right: 12px;">
            <span style="font-weight: 500; font-size:20px; ">TD Food Voucher</span>
        </div>
        <button onclick="openVoucherModal()" style="color: #0071c2;  border: none; background:none; font-size: 16px;">
            Chọn Voucher
        </button>
    </div>

    <div style="display: flex; align-items: center;">
        <img src="https://i.postimg.cc/xTMkHjk6/coin.png" alt="Xu Icon"
             style="width: 25px; height:25px; margin-right: 12px;">
        <span style="font-weight: 500; font-size:20px;">TD Food Xu</span>
        <span style="margin-left: 10px; color: #888;">Dùng {{ '{:,.0f}'.format(coin_balance).replace(',', '.') }} Xu</span>

        <!-- Nằm bên phải -->
        <div style="display: flex; align-items: center; margin-left: auto;">
              <span style="color: #999; font-size: 14px; margin-right: 5px;">
                [-₫{{ '{:,.0f}'.format(coin_balance).replace(',', '.') }}]
              </span>
            <input type="checkbox" id="use-coin-checkbox" {% if session.get ('use_coin') %}checked{% endif %} />
        </div>
    </div>

    <!--✅ Modal cho voucher-->
    <div id="modals-voucher-order"
         style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;"
         onclick="closeVoucherModal(event)">
        <div id="voucher-modal-content"
             style="background: #fff; border-radius: 8px; width: 100%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;"
             onclick="event.stopPropagation()">

            <!-- Header -->
            <div style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid #ddd; background: #fff; position: sticky; top: 0; z-index: 1;">
                <h3 style="margin: 0; padding:10px 10px;">Chọn Voucher của TD Food</h3>
            </div>

            <!-- Body -->
            <div style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: row; gap: 1px;">
                {{ voucher_macros.voucher_modal(vouchers,order_total_amount_selected, session_voucher_code) }}
            </div>

            <!-- Footer -->
            <div style="flex-shrink: 0; display: flex; justify-content: flex-end; align-items: center; padding: 12px 20px; border-top: 1px solid #ddd; background: #fff; position: sticky; bottom: 0; z-index: 1;">
                <button onclick="closeVoucherModal()"
                        style="padding: 8px 16px; margin-right: 10px; border: none; background: #ccc; color: #333; border-radius: 4px;">
                    Hủy
                </button>
                <button onclick="confirmVoucher()"
                        style="padding: 8px 16px; border: none; background: #0071c2; color: #fff; border-radius: 4px;">
                    Xác nhận
                </button>
            </div>

        </div>
    </div>

    <script>

        // ✅ Nut checkbox sử dụng coin
        document.addEventListener('DOMContentLoaded', () => {
          const coinCheckbox = document.getElementById('use-coin-checkbox');
          const totalPaymentAmount = document.getElementById('total-payment-amount');
          const coinUsedAmount = document.getElementById('coin-used-amount');

          const userCoin = {{ coin_balance | int }};
          const initialTotal = {{ order_total_amount_selected | int }};

          coinCheckbox.addEventListener('change', () => {
            fetch('/api/set_use_coin', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ use_coin: coinCheckbox.checked })
            })
            .then(res => res.json())
            .then(data => {
              if (data.code === 200) {
                // ✅ Chỉ đổi số
                totalPaymentAmount.textContent = Number(data.new_total).toLocaleString('vi-VN');

                // ✅ Coin dùng
                coinUsedAmount.textContent = coinCheckbox.checked
                  ? userCoin.toLocaleString('vi-VN')
                  : '0';
              } else {
                alert('Có lỗi xảy ra!');
              }
            })
            .catch(err => console.error(err));
          });
        });



      // ⚡️✅ Biến GLOBAL
      var sessionVoucherCode = "{{ session_voucher_code | default('', true) }}";
      var orderTotal = {{ order_total_amount_selected | int }};
      var selectedVoucher = {
        code: sessionVoucherCode || null,
        price: 0,
        minOrder: 0
      };

      // ⚡✅️ Khi DOM ready
      document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('.copy-button');
        const wrappers = document.querySelectorAll('.voucher-code-wrapper');

        // ✅ Nếu có voucher session → hiển thị ngay
        if (sessionVoucherCode) {
          buttons.forEach(b => {
            if (b.dataset.voucherCode === sessionVoucherCode) {
              const price = parseInt(b.dataset.voucherPrice) || 0;
              const minOrder = parseInt(b.dataset.minOrder) || 0;
              selectedVoucher = {
                code: sessionVoucherCode,
                price: price,
                minOrder: minOrder
              };
              updateButtonState(b);
            }
          });
        }

        // ✅ Click nút chọn mã
        buttons.forEach(button => {
          button.addEventListener('click', function () {
            handleVoucherClick(this, buttons);
          });
        });

        // ✅ Click wrapper
        wrappers.forEach(wrapper => {
          wrapper.addEventListener('click', function () {
            const button = this.closest('.voucher-card').querySelector('.copy-button');
            handleVoucherClick(button, buttons);
          });
        });
      });

      // ✅ Hàm xử lý bấm chọn
      function handleVoucherClick(button, buttons) {
        const code = button.dataset.voucherCode;
        const price = parseInt(button.dataset.voucherPrice) || 0;
        const minOrder = parseInt(button.dataset.minOrder) || 0;

        if (orderTotal < minOrder) {
          showVoucherError(`Đơn hàng phải từ ₫${minOrder.toLocaleString('vi-VN')} mới áp dụng được voucher này!`);
          return;
        }

        if (selectedVoucher.code === code) {
          selectedVoucher = { code: null, price: 0, minOrder: 0 };
        } else {
          selectedVoucher = { code: code, price: price, minOrder: minOrder };
        }
        resetVoucherUI();
      }

      // ✅ Reset nút theo selectedVoucher hiện tại
      function resetVoucherUI() {
        const buttons = document.querySelectorAll('.copy-button');
        buttons.forEach(b => {
          if (b.dataset.voucherCode === selectedVoucher.code) {
            updateButtonState(b);
          } else {
            b.textContent = 'Chọn mã';
            b.classList.remove('copied');
          }
        });
      }

      function updateButtonState(button) {
        button.textContent = 'Đã chọn';
        button.classList.add('copied');
      }

      // ✅ Xác nhận
      function confirmVoucher() {
        if (!selectedVoucher.code) {
          fetch("/api/set_voucher", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code: null })
          }).then(res => res.json()).then(data => {
            if (data.code === 200) location.reload();
            else alert(data.message);
          }).catch(err => console.error(err));
          return;
        }

        if (orderTotal < selectedVoucher.minOrder) {
          showVoucherError(`Đơn hàng phải từ ₫${selectedVoucher.minOrder.toLocaleString('vi-VN')} mới áp dụng được voucher này!`);
          return;
        }

        fetch("/api/set_voucher", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: selectedVoucher.code })
        }).then(res => res.json()).then(data => {
          if (data.code === 200) location.reload();
          else alert(data.message);
        }).catch(err => console.error(err));
      }

      function showVoucherError(msg) {
        document.getElementById('voucher-error-message').textContent = msg;
        document.getElementById('voucher-error-modal').style.display = 'flex';
      }

      function closeVoucherErrorModal(evt) {
        if (!evt || evt.target.id === 'voucher-error-modal') {
          document.getElementById('voucher-error-modal').style.display = 'none';
        }
      }
            // ✅ Trả giá trị session voucher code về 0
          function openVoucherModal() {
            // ✅ Reset về session
            selectedVoucher = {
              code: sessionVoucherCode || null,
              price: 0,
              minOrder: 0
            };
            // ✅ Gọi reset UI
            resetVoucherUI();
            // ✅ Mở modal
            document.getElementById('modals-voucher-order').style.display = 'flex';
          }

          function closeVoucherModal(evt) {
            if (!evt || evt.target.id === 'modals-voucher-order') {
              document.getElementById('modals-voucher-order').style.display = 'none';
            }
          }
    </script>

</div>


<div style="border: 1px solid #eee; background: #fff; padding: 20px; margin-top: 20px; margin-bottom: 20px;">
    <!-- Phương thức thanh toán -->

    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; background-color:#fffefb;">
        <h3 style="margin: 0; font-size: 22px; font-weight: 500;">Phương thức thanh toán</h3>
    </div>

    <!-- Các tuỳ chọn thanh toán -->
    <div style="justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding:20px; background-color:#fffefb;">
        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
            <input type="radio" name="payment_method" value="COD"
                   {% if payment_method== 'COD' %}checked{% endif %}
            style="margin-right: 10px;">
            <img src="https://i.postimg.cc/mg0F7g3K/cod.png"
                 style="width: 50px; height: 50px; margin-right: 8px; border-radius:5px;">
            Thanh toán khi nhận hàng
        </label>

        <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="payment_method" value="MoMo"
                   {% if payment_method== 'MoMo' %}checked{% endif %}
            style="margin-right: 10px;">
            <img src="https://play-lh.googleusercontent.com/uCtnppeJ9ENYdJaSL5av-ZL1ZM1f3b35u9k8EOEjK3ZdyG509_2osbXGH5qzXVmoFv0"
                 style="width: 44px; height: 44px; margin-right: 8px; border-radius:5px; margin-left: 3px; margin-right: 14px;">
            Ví điện tử MoMo
        </label>

        <script>
            // Chờ DOM load
            document.addEventListener('DOMContentLoaded', function () {
              const radios = document.querySelectorAll('input[name="payment_method"]');

              radios.forEach(radio => {
                radio.addEventListener('change', function () {
                  const method = this.value;
                  fetch('/api/set_payment_method', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payment_method: method })
                  }).then(res => res.json()).then(data => {
                    console.log('Đã lưu phương thức:', method);
                  });
                });
              });
            });
        </script>

    </div>

    <!-- Chi tiết tổng tiền -->
    <div style="padding: 20px 0;  max-width: 400px; margin-left: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: rgba(0, 0, 0, .54);">Tổng tiền hàng</span>
            <span style="color: #333;"> <span style="vertical-align: 3px; font-size:12px;">₫</span>{{ '{:,.0f}'.format(order_total_amount_selected).replace(',','.') }}</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: rgba(0, 0, 0, .54);">Phí vận chuyển</span>
            <span style="color: #333;"> <span style="vertical-align: 3px; font-size:12px;">₫</span>0</span>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: rgba(0, 0, 0, .54);">Voucher giảm</span>
            <span style="color:#ee4d2d;  #;"> <span style="vertical-align: 3px; font-size:12px;">-₫</span>{{ '{:,.0f}'.format(voucher_discount).replace(',','.') }}</span>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: rgba(0, 0, 0, .54);">Đã dùng Xu TD Food</span>
            <span style="color: #ee4d2d;">
            <span style="vertical-align: 3px; font-size:12px;">-₫</span><span id="coin-used-amount"
                                                                              style="font-size: 16px;">{% if session.get('use_coin') %}{{'{:,.0f}'.format(coin_balance).replace(',', '.')}}{% else %}0{% endif %}
            </span>
          </span>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
            <span style="color: rgba(0, 0, 0, .54); font-weight: 500;">Tổng thanh toán</span>
            <span id="total-payment" style="color: #ee4d2d; font-size: 30px;">
              <span style="vertical-align: 7px; font-size:20px;">₫</span><span id="total-payment-amount">{{ '{:,.0f}'.format(order_total_amount_after_discount).replace(',','.') }}</span>
            </span>
        </div>

        <div style="text-align: right; font-size: 12px; color: #999; margin-top: 5px;">
            Đã bao gồm thuế
        </div>
    </div>


    <!-- Khối nằm ngang -->
    <div style="display: flex; justify-content: space-between; align-items: center;  flex-wrap: wrap;border-top: 1px solid #eee; padding-top: 20px;">

        <!-- Điều khoản bên trái -->
        <p style="font-size: 15px; color: #999; margin: 0;">
            Nhấn "Đặt hàng" đồng nghĩa với việc bạn đồng ý tuân theo
            <span onclick="openModal('termsModal')" style="color: #0055aa; text-decoration: none; cursor: pointer;">
          Điều khoản TD Food
        </span>
        </p>

        <!-- Nút Đặt hàng bên phải -->
        <button id="btn-order"
                type="button"
                class="datHang">
            Đặt hàng
        </button>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const btnOrder = document.getElementById('btn-order');
                const noteMessageInput = document.getElementById('note_message');
                let isOrdering = false;

                // Lưu note_message vào session khi nhập
                noteMessageInput.addEventListener('input', function() {
                    const noteMessage = this.value;
                    fetch('/api/set_note_message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ note_message: noteMessage })
                    })
                    .then(res => res.json())
                    .then(data => {
                        console.log(data.message); // Debug
                    })
                    .catch(err => console.error('Error saving note:', err));
                });

                btnOrder.addEventListener('click', function() {
                  if (isOrdering) return;

                  isOrdering = true;
                  btnOrder.disabled = true;

                  const noteMessage = noteMessageInput.value;

                  fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note_message: noteMessage })
                  })
                  .then(res => res.json())
                  .then(data => {
                    if (data.payUrl) {
                      // 👉 Chuyển thẳng qua link MoMo luôn
                      window.location.href = data.payUrl;
                    } else if (data.redirect_url) {
                      window.location.href = data.redirect_url;
                    } else {
                      alert(data.message);
                      btnOrder.disabled = false;
                      isOrdering = false;
                    }
                  })
                  .catch(err => {
                    console.error(err);
                    alert("Có lỗi xảy ra!");
                    btnOrder.disabled = false;
                    isOrdering = false;
                  });
                });

                // Khôi phục note_message từ session khi tải trang
                fetch('/api/get_note_message')
                    .then(res => res.json())
                    .then(data => {
                        if (data.note_message) {
                            noteMessageInput.value = data.note_message;
                        }
                    })
                    .catch(err => console.error('Error loading note:', err));
            });
        </script>


    </div>

</div>

<!--// ✅Style cho nút Đặt hàng-->
<style>
    .datHang {
            background-color: #ee4d2d;
            color: white;
            border: none;
            padding: 8px 72px;
            font-size: 16px;
            border-radius: 2px;
            cursor: pointer;
    }
    .datHang:hover {
            background-color: #d73211;
            color: white;
    }
</style>

{%endblock%}


